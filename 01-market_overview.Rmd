# Short-term rentals in Vancouver: Market overview

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```

```{r new_objects, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())

# 2019 active
active_2019 <- 
  daily %>%
  filter(housing, status %in% c("R", "A"), date <= LTM_end_date, 
         date >= LTM_start_date) %>%
  pull(property_ID) %>% 
  unique()
  
# 2019 revenue
revenue_2019 <-
  daily %>%
  filter(housing, status == "R", date <= LTM_end_date, 
         date >= LTM_start_date) %>%
  group_by(property_ID) %>%
  summarize(revenue_LTM = sum(price), .groups = "drop") %>% 
  inner_join(property, ., by = "property_ID")

# Active listings
active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date, listing_type) %>% 
  group_by(listing_type) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup()

active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE),
         listing_type = "All listings") %>% 
  bind_rows(active_listings) %>% 
  arrange(date, listing_type)

# Daily variation
daily_variation <- 
  daily %>% 
  filter(housing, status != "B", date >= "2015-12-16", date != "2020-02-29") %>% 
  group_by(date) %>% 
  summarize("Active listings" = n(), Revenue = sum(price[status == "R"])) %>% 
  mutate(across(where(is.numeric), 
                function(x) slide_dbl(x, ~{(.x[366] - .x[1]) / .x[1]}, 
                                      .before = 365, .complete = FALSE))) %>% 
  pivot_longer(-date, names_to = "var", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(value = slide_dbl(value, mean, .before = 13, .complete = TRUE)) %>% 
  ungroup() %>% 
  filter(date >= "2017-05-01")

# LA breakdown
LA_breakdown <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date - years(1), 
         date <= LTM_end_date) %>% 
  group_by(date, area) %>% 
  summarize(n = n(),
            revenue = sum(price[status == "R"])) %>% 
  left_join(st_drop_geometry(LA)) %>% 
  group_by(area, dwellings) %>% 
  summarize(active_listings = mean(n[date >= LTM_start_date]),
            active_2018 = mean(n[date < LTM_start_date]),
            active_growth = (active_listings - active_2018) / active_2018,
            annual_rev = sum(revenue[date >= LTM_start_date]),
            rev_2018 = sum(revenue[date < LTM_start_date]),
            rev_growth = (annual_rev - rev_2018) / rev_2018,
            .groups = "drop") %>% 
  mutate(listings_pct = active_listings / sum(active_listings, na.rm = TRUE),
         listings_pct_dwellings = active_listings / dwellings,
         rev_pct = annual_rev / sum(annual_rev)) %>% 
  select(area, active_listings, active_growth, listings_pct,
         listings_pct_dwellings, annual_rev, rev_pct, rev_growth)

# Active listings by LA
active_area <-
  daily %>%
  filter(housing, status != "B", date >= LTM_start_date, 
         date <= LTM_end_date) %>%
  count(area, date) %>% 
  group_by(area) %>% 
  summarize(n = mean(n, na.rm = TRUE)) %>%
  left_join(LA, .) %>% 
  mutate(percentage = n / dwellings, n = round(n, digit = -1)) %>% 
  select(area, n, dwellings, percentage)

# Active listings by DA
active_DA <-
  daily %>%
  filter(housing, status != "B", date >= LTM_start_date,
         date <= LTM_end_date) %>%
  left_join(select(st_drop_geometry(property), property_ID, GeoUID)) %>% 
  count(GeoUID, date) %>% 
  group_by(GeoUID) %>% 
  summarize(n = mean(n, na.rm = TRUE)) %>%
  left_join(DA, .) %>% 
  mutate(percentage = n / dwellings, n = round(n, digit = -1),
         percentage = if_else(dwellings <= 4, NA_real_, percentage)) %>% 
  relocate(geometry, .after = last_col())

# Listing type breakdown
listing_type_breakdown <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date,
         date <= LTM_end_date) %>% 
  group_by(listing_type) %>% 
  summarize(
    active_listings = n() / 365,
    revenue = sum(price[status == "R"]),
    .groups = "drop") %>% 
  mutate(pct_of_listings = active_listings / sum(active_listings),
         pct_of_revenue = revenue / sum(revenue))

listing_type_breakdown <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date - years(1), 
         date <= LTM_end_date - years(1)) %>% 
  group_by(listing_type) %>% 
  summarize(active_2018 = n() / 365) %>% 
  left_join(listing_type_breakdown, .) %>% 
  mutate(pct_listing_growth = (active_listings - active_2018) / active_2018) %>% 
  select(-active_2018)

# Host revenue table for calculations and table
host_rev <-
  daily %>%
  filter(housing, date >= LTM_start_date, date <= LTM_end_date, 
         status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price))

rm(property, daily, GH, CMA, DA, city, BL, BL_expanded, skytrain)

```

```{r exec_summ, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Average active and blocked daily listings in 2019
avg_listings <- 
  daily %>% 
  filter(housing, date >= LTM_start_date, date <= LTM_end_date) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active <- 
  avg_listings$avg[1] %>% 
  prettyNum(",")

# Total annual revenue
annual_rev <- 
  revenue_2019$revenue_LTM %>% 
  sum() %>% 
  {. / 1000000} %>% 
  round(digit = 1) %>% 
  prettyNum(",") %>% 
  paste0("$", ., " million")

# EH listings
eh_listings <- 
  listing_type_breakdown %>% 
  filter(listing_type == "Entire home/apt") %>% 
  pull(pct_of_listings) %>% 
  scales::percent(0.1)

# EH revenue
eh_revenue <- 
  listing_type_breakdown %>% 
  filter(listing_type == "Entire home/apt") %>% 
  pull(pct_of_revenue) %>% 
  scales::percent(0.1)

# Host revenue
host_rev_top_10 <- 
  host_rev %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_1 <- 
  host_rev %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

# 2019 ML listings
ml_listings <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date, 
         date <= LTM_end_date) %>% 
  count(multi) %>% 
  summarize(ML = n[2] / sum(n)) %>% 
  pull(ML) %>% 
  scales::percent(0.1)

# 2019 ML revenue
ml_revenue <- 
  daily %>% 
  filter(housing, status == "R", date >= LTM_start_date, 
       date <= LTM_end_date) %>% 
  group_by(multi) %>% 
  tally(price) %>% 
  summarize(multi_rev = n[2] / sum(n)) %>% 
  pull(multi_rev) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

**There were `r avg_listings_active` active STR listings in Vancouver housing units in 2019, which collectively earned `r annual_rev`. A quarter of all listings are in the Downtown area. More than two thirds (`r eh_listings`) of Vancouver’s STR listings are entire homes, and entire homes are responsible for `r eh_revenue` of all revenue. Revenue is concentrated unevenly among hosts, with the top 10% earning `r host_rev_top_10` of revenue, and the top 1% earning `r host_rev_top_1`, but Vancouver has much less revenue concentration than other large cities in Canada. Commercial operators who control multiple STR listings account for `r ml_listings` listings and `r ml_revenue` revenue, and those shares have been falling consistently since the introduction of the City's 2018 STR regulations.**

<br>

## Active daily listings and annual revenue

```{r para_1, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Average active and blocked daily listings in 2019
avg_listings <- 
  daily %>% 
  filter(housing, date >= LTM_start_date, date <= LTM_end_date) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active <- 
  avg_listings$avg[1] %>% 
  prettyNum(",")

# Average number of hosts (taking out blocked 365 days)
avg_hosts <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date, 
         date <= LTM_end_date) %>%
  count(date, host_ID) %>% 
  count(date) %>% 
  summarize(hosts = round(mean(n), digit = -1), .groups = "drop") %>% 
  pull(hosts) %>% 
  prettyNum(",")

# Total annual revenue
annual_rev <- 
  revenue_2019$revenue_LTM %>% 
  sum() %>% 
  {. / 1000000} %>% 
  round(digit = 1) %>% 
  prettyNum(",") %>% 
  paste0("$", ., " million")

# Average revenue per active listing
avg_rev_per_listing <- 
  (sum(revenue_2019$revenue_LTM) /
    daily %>% 
    filter(housing, status != "B", date >= LTM_start_date, 
           date <= LTM_end_date) %>% 
    count(date) %>% 
    summarize(avg_rev_per_active = round(mean(n)), .groups = "drop")) %>% 
  as.vector() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

#' Average revenue per active host
avg_rev_per_host <- 
  (sum(revenue_2019$revenue_LTM) /
    daily %>% 
    filter(housing, status != "B", date >= LTM_start_date, 
           date <= LTM_end_date) %>%
    group_by(date) %>% 
    summarize(n_hosts = length(unique(host_ID)), .groups = "drop_last") %>% 
    summarize(avg_n_hosts = round(mean(n_hosts)), .groups = "drop")) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

rm(property, daily, GH)

```

``` {r make_fig_1_1}

figure_1_1_fun <- function(regular = "", condensed = "") {
  
  active_listings %>% 
  ggplot(aes(date, n, colour = listing_type, size = listing_type)) +
  annotate("segment", x = key_date_covid, xend = key_date_covid,
           y = -Inf, yend = Inf, alpha = 0.3) +
  annotate("curve", x = as.Date("2019-08-01"), xend = key_date_covid - days(10),
           y = 5000, yend = 4700, curvature = -.2, lwd = 0.25,
           arrow = arrow(length = unit(0.05, "inches"))) +
  annotate("text", x = as.Date("2019-05-01"), y = 5000,
           label = "Covid-19 \nAirbnb's response", family = condensed) +
  annotate("segment", x = key_date_regulations, xend = key_date_regulations,
           y = -Inf, yend = Inf, alpha = 0.3) +
  annotate("curve", x = as.Date("2018-06-01"), xend = key_date_regulations - days(10),
           y = 5200, yend = 5100, curvature = -.2, lwd = 0.25,
           arrow = arrow(length = unit(0.05, "inches"))) +
  annotate("text", x = as.Date("2018-02-01"), y = 5200,
           label = "Regulations", family = condensed)+
  geom_line(na.rm = TRUE) +
  scale_y_continuous(name = NULL, label = scales::comma) +
  scale_x_date(name = NULL, limits = c(as.Date("2016-01-01"), NA)) +
  scale_colour_manual(name = NULL, values = col_palette[c(5, 1:3)],
                      guide = guide_legend(
                        override.aes = list(size = c(1.5, 0.75, 0.75, 0.75)))) +
  scale_size_manual(values = c("All listings" = 1.5, "Entire home/apt" = 0.75,
                               "Private room" = 0.75, "Shared room" = 0.75),
                    guide = "none") +
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_1.pdf"), 
         plot = figure_1_1_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_1.pdf"))
}

```

Active daily listings are listings which were displayed on Airbnb or VRBO on a given day, and were either reserved or available for a reservation. It is the most reliable means of determining the overall size of the STR market in a location, particularly with respect to change over time. In 2019 there was an average of `r avg_listings_active` active daily listings (Figure \@ref(fig:fig-1-1)) operated by an average of `r avg_hosts` hosts. These hosts collectively earned `r annual_rev`—an average of `r avg_rev_per_listing` per daily active listing or `r avg_rev_per_host` per active host.

``` {r fig-1-1, include = TRUE, fig.cap = '(ref:fig-1-1)', fig.align = "center"}

figure_1_1_fun()

```

(ref:fig-1-1) _Active daily STRs in the City of Vancouver (7-day average)_

``` {r para_2, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Average blocked daily listings in 2019
avg_listings_blocked <- 
  avg_listings$avg[2] %>% 
  prettyNum(",")

# Average revenue per all listings
avg_revenue_all_listings <- 
  revenue_2019$revenue_LTM %>% 
  mean() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per all hosts
avg_revenue_all_hosts <- 
  revenue_2019 %>% 
  st_drop_geometry() %>%
  filter(!is.na(host_ID)) %>%
  group_by(host_ID) %>% 
  summarize("host_rev" = sum(revenue_LTM)) %>% 
  summarize("avg_host_rev" = prettyNum(round(mean(host_rev), digit = -2), ",")) %>% 
  pull(avg_host_rev) %>% 
  paste0("$", .)

# Non-housing active listings
non_housing_listings <- 
  daily %>% 
  filter(!housing, status != "B", date >= LTM_start_date, 
         date <= LTM_end_date) %>%
  count(date) %>% 
  summarize(non_housing = round(mean(n), digit = -1)) %>% 
  pull(non_housing) %>% 
  prettyNum(",")

rm(property, daily, GH)

```

There was also a daily average of `r avg_listings_blocked` listings which were visible on the Airbnb and VRBO websites but were blocked by the host from receiving reservations. The presence of these listings can erroneously suggest that a city’s STR market is larger than it is. When these blocked but inactive listings are included, the average listing earned `r avg_revenue_all_listings` last year, and the average host earned `r avg_revenue_all_hosts`. Finally, there was a daily average of `r non_housing_listings` listings that were not located in private housing units (B&Bs, hotels, etc.), which have been excluded from the analysis in this report. All the figures which follow, therefore, pertain to short-term rentals located in Vancouver’s traditional residential housing stock.

``` {r para_3, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Date and amount of highest activity
highest_activity <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  filter(n == max(n)) %>% 
  group_by(date) %>% 
  summarize(daily_max = round((n), digit = -1))

highest_activity_date <-
  highest_activity$date %>% 
  {paste0(month.name[as.numeric(substr(., 6, 7))], " ", substr(., 1, 4))}

highest_activity_amount <- 
  highest_activity$daily_max %>% 
  prettyNum(",")

# Active listing YOY change
active_yoy_change <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date - years(1), 
         date <= LTM_end_date) %>% 
  group_by(year_2019 = date >= LTM_start_date) %>% 
  summarize(active_listings = n() / 365,
            revenue = sum(price[status == "R"]), .groups = "drop") %>% 
  summarize(across(c(active_listings, revenue), ~{(.x[2] - .x[1]) / .x[1]}),
            .groups = "drop")

active_yoy_listings <- 
  active_yoy_change$active_listings %>% 
  {. * -1} %>% 
  scales::percent(accuracy = 0.1)

active_yoy_revenue <- 
  active_yoy_change$revenue %>% 
  scales::percent(accuracy = 0.1)

rm(property, daily, GH)

```

Active daily listings peaked in `r highest_activity_date` at `r highest_activity_amount`, and have since declined. There were  `r active_yoy_listings` fewer listings active on average in 2019 than in 2018. However, host revenue followed the opposite pattern, increasing by `r active_yoy_revenue` between 2018 and 2019. The regulations succeeded in reducing the number of active listings, however listings which remained on the platforms are earning a slightly higher revenue than during the previous year.

In general, the number of STR listings available in the City of Vancouver peaks during late summer and winter holidays and falling in between these periods (Figure \@ref(fig:fig-1-1)). There are two major exceptions to this pattern: the sharp drop in activity in the second half of 2018 after the City's STR regulations began to be enforced, and the March to September 2020 period, where activity has been sharply below the seasonal trend because of the Covid-19 pandemic.
  
<br>

## STR growth rates

``` {r make_fig_1_2}

figure_1_2_fun <- function(regular = "", condensed = "") {
  
  daily_variation %>% 
  ggplot(aes(date, value, colour = var)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  annotate("segment", x = key_date_covid, xend = key_date_covid,
           y = -Inf, yend = Inf, alpha = 0.3) +
  annotate("segment", x = key_date_regulations, xend = key_date_regulations,
           y = -Inf, yend = Inf, alpha = 0.3) +
  geom_line(lwd = 1, na.rm = TRUE) +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL, limits = c(-1, NA), 
                     labels = scales::percent) +
  scale_color_manual(name = NULL, values = col_palette[c(5, 1)]) +
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_2.pdf"), 
         plot = figure_1_2_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_2.pdf"))
}

```

Until mid-2018 the number of active STRs listings steadily increased in the City of Vancouver. Figure \@ref(fig:fig-1-2) shows the change in active listings and revenue relative to one year earlier, which is a convenient way to remove seasonal variation to identify underlying growth trends. The figure indicates that, throughout 2017 and the first half of 2018, there were almost always more listings available than the previous year. This situation reversed itself in late 2018, and for a year between the mid 2018 to mid 2019, the number of active listings has consistently been lower than the previous year. The previous growth trends then returned until March 2020.

``` {r fig-1-2, include = TRUE, fig.cap = '(ref:fig-1-2)', fig.align = "center"}

figure_1_2_fun()

```

(ref:fig-1-2) _Change in daily active listings and host revenue compared to one year earlier (14-day average)_


``` {r para_4, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# YOY listing growth, 2016-2017
listing_growth_2017 <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date - years(3),
         date <= LTM_end_date - years(2)) %>% 
  group_by(year_2017 = date >= LTM_start_date - years(2)) %>% 
  summarize(n = n() / 365) %>% 
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

# YOY listing growth, 2017-2018
listing_growth_2018 <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date - years(2),
         date <= LTM_end_date - years(1)) %>% 
  group_by(year_2018 = date >= LTM_start_date - years(1)) %>% 
  summarize(n = n() / 365) %>% 
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

#' YOY listing growth, 2018-2019
listing_growth_2019 <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date - years(1),
         date <= LTM_end_date) %>% 
  group_by(year_2019 = date >= LTM_start_date) %>% 
  summarize(n = n() / 365) %>% 
  summarize(change = (n[2] - n[1]) / n[1])  %>% 
  pull(change) %>% 
  scales::percent(0.1)

# End month
end_month <- 
  max(daily$date) %>% 
  substr(6, 7) %>% 
  as.numeric() %>% 
  {month.name[.]}

# YOY listing growth, 2019-2020
listing_growth_2020 <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date,
         date <= LTM_end_date + years(1),
         (date <= max(daily$date) - years(1) | date >= LTM_start_date + years(1)),
         date != "2020-02-29") %>%
  group_by(year_2020 = date >= LTM_start_date + years(1)) %>% 
  summarize(n = n() / as.numeric((max(daily$date) - as.Date("2020-01-01")))) %>% 
  summarize(change = (n[2] - n[1]) / n[1])  %>% 
  pull(change) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

Overall, the year-over-year change in average active listings from 2016 to 2017 (12 months) was `r listing_growth_2017`, the year-over-year change from 2017 to 2018 was `r listing_growth_2018`, and the year-over-year change from 2018 to 2019 was `r listing_growth_2019`. In 2020, active listings fell faster thanks to the Covid-19 pandemic. The year-over-year change in active daily listings for 2020 so far (January to `r end_month`) is `r listing_growth_2020`.

``` {r para_5, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# YOY reservation change, 2018-2019
reservation_change_2019 <- 
  daily %>%
  filter(housing, status == "R", date >= LTM_start_date - years(1),
         date <= LTM_end_date) %>%
  group_by(year_2019 = date >= LTM_start_date) %>%
  summarize(n = n()) %>%
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

# Reservation counts, 2018-2019
reservation_count_2019 <- 
  daily %>%
  filter(housing, status == "R", date >= LTM_start_date - years(1),
         date <= LTM_end_date) %>%
  group_by(year_2019 = date >= LTM_start_date) %>%
  summarize(n = n()) %>% 
  mutate(n = n / 1000000,
         n = round(n, 2),
         n = paste0(n, " million")) %>% 
  pull(n)

# YOY revenue change, 2019-2020
active_yoy_revenue_2020 <- 
  daily %>%
  filter(housing, status == "R", date >= LTM_start_date,
         date <= LTM_end_date + years(1),
         (date <= "2019-07-31" | date >= LTM_start_date + years(1)),
         date != "2020-02-29") %>%
  group_by(year_2020 = date >= LTM_start_date + years(1)) %>%
  summarize(revenue = sum(price)) %>%
  summarize(change = (revenue[2] - revenue[1]) / revenue[1]) %>% 
  pull(change) %>% 
  {. * -1} %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

The growth rate of reservations and host revenue tells a different story. Despite there being fewer active listings in 2019 than in 2018, the number of reserved nights increased by `r reservation_change_2019`, from `r reservation_count_2019[1]` reserved nights to `r reservation_count_2019[2]` reserved nights, while revenue increased `r active_yoy_revenue`. Due to the Covid-19 pandemic, revenue from January to `r end_month` 2020 is down `r active_yoy_revenue_2020` compared to the same time last year.

Until mid-2018, when the City's STR regulations came into effect, the growth rate of active listings was always positive but weaker than revenue growth, which indicates that both total listings and revenue per listing were growing. Both rates fell sharply through the second half of 2018, and in fact became negative, as the City's regulations reduced the size of Vancouver's STR market. STR listing and revenue growth resumed in Fall 2019, and revenue growth in particular reached record highs in late 2019 and early 2020, until the Covid-19 pandemic caused both listing and revenue growth to collapse. Neither has yet recovered.
  
<br>

## Vancouver in comparison with other major Canadian cities

``` {r para_6, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "national_comparison.qs"))}

national_comparison <- qread(here("output", "national_comparison.qs"),
                             nthreads = availableCores())

van_active_per_1000 <- 
  national_comparison %>% 
  filter(city == "Vancouver") %>% 
  pull(listings_per_1000) %>% 
  round(1) %>% 
  prettyNum(",")

mtl_active_per_1000 <- 
  national_comparison %>% 
  filter(city == "Montreal") %>% 
  pull(listings_per_1000) %>% 
  round(1) %>% 
  prettyNum(",")

van_rev_per_listing <- 
  national_comparison %>% 
  filter(city == "Vancouver") %>% 
  pull(revenue_per_listing) %>% 
  round(-2) %>% 
  scales::dollar()

to_rev_per_listing <- 
  national_comparison %>% 
  filter(city == "Toronto") %>% 
  pull(revenue_per_listing) %>% 
  round(-2) %>% 
  scales::dollar()

```

In 2019, Vancouver had the third largest STR market in the country by both active listing numbers (`r avg_listings_active`) and host revenue (`r annual_rev`), falling in both cases behind Toronto and Montreal (Table \@ref(tab:tab-1-1)). However, in relative terms, Vancouver stands considerably ahead of both Montreal and Toronto. Vancouver had the most active listings per 1000 households (`r van_active_per_1000` compared to `r mtl_active_per_1000` in Montreal) and the most revenue per listing (`r van_rev_per_listing` compared to `r to_rev_per_listing` in Toronto).

``` {r tab-1-1, include = TRUE}

library(kableExtra)

national_comparison <- qread(here("output", "national_comparison.qs"),
                             nthreads = availableCores())

national_comparison %>% 
  transmute(
    city, 
    active_daily_listings = prettyNum(round(active_daily_listings, -1), ","),
    listings_per_1000 = round(listings_per_1000, 1),
    revenue = scales::dollar(revenue, 0.1, 1/1000000),
    revenue_per_listing = scales::dollar(revenue_per_listing, 100)) %>% 
  set_names(c("City", "Active listings", "Listings per 1000 households",
              "Annual revenue (million)", "Revenue per listing")) %>% 
  kbl(caption = "2019 STR activity in the largest ten Canadian municipalities",
      align = "lrrrr") %>%
  kable_styling(latex_options="scale_down") %>%
  row_spec(9, background = paste0(col_palette[2], "50"))
  
```

<br>

## Location of STR listings and revenue

``` {r para_7}

downtown_listing_pct <- 
  LA_breakdown %>% 
  filter(area == "Downtown") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

downtown_rev_pct <- 
  LA_breakdown %>% 
  filter(area == "Downtown") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

kits_listing_pct <- 
  LA_breakdown %>% 
  filter(area == "Kitsilano") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

kits_rev_pct <- 
  LA_breakdown %>% 
  filter(area == "Kitsilano") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

west_listing_pct <- 
  LA_breakdown %>% 
  filter(area == "West End") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

west_rev_pct <- 
  LA_breakdown %>% 
  filter(area == "West End") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

downtown_per_cap <- 
  LA_breakdown %>% 
  filter(area == "Downtown") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

riley_per_cap <- 
  LA_breakdown %>% 
  filter(area == "Riley Park") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

min_per_cap <- 
  LA_breakdown %>% 
  filter(active_listings > 100) %>% 
  pull(listings_pct) %>% 
  min() %>% 
  scales::percent(0.1)

max_per_cap <- 
  LA_breakdown %>% 
  filter(active_listings > 100, 
         !active_listings %in% c("Downtown", "Riley Park")) %>% 
  pull(listings_pct) %>% 
  max() %>% 
  scales::percent(0.1)

```

``` {r make_fig_1_3}

figure_1_3_fun <- function(regular = "", condensed = "") {
  
  left_map <- 
    active_area %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = percentage), colour = "white") +
    scale_fill_gradientn(colors = col_palette[c(5, 2, 3, 7, 4)], 
                         na.value = "grey80",
                         limits = c(0, 0.05), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "STRs/\ndwelling",
                                  title.vjust = 1)) + 
    gg_bbox(active_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  right_map <- 
    active_DA %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = percentage), colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(5, 2, 3, 7, 4)], 
                         na.value = "grey80",
                         limits = c(0, 0.05), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "STRs/\ndwelling",
                                  title.vjust = 1)) + 
    gg_bbox(active_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  left_map + right_map + plot_layout(guide = "collect") & 
    theme(legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_3.pdf"), 
         plot = figure_1_3_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_3.pdf"))
}

```

STR activity in Vancouver is highly concentrated in the Downtown (Figure \@ref(fig:fig-1-3)). This area accounts for `r downtown_listing_pct` of all listings in 2019, and an even higher share of host revenue (`r downtown_rev_pct`). Downtown is followed by Kitsilano (`r kits_listing_pct` of active listings and `r kits_rev_pct` of revenue) and the West End (`r west_listing_pct` of active listings and `r west_rev_pct` of revenue). When measured in per-capita terms, Downtown and Riley Park have the highest concentrations of STRs, at `r downtown_per_cap` and `r riley_per_cap` respectively. In all other areas STRs account for between `r min_per_cap` and `r max_per_cap` of total dwellings.


``` {r fig-1-3, include = TRUE, fig.cap = '(ref:fig-1-3)', fig.align = "center"}

figure_1_3_fun()

```

(ref:fig-1-3) _Active STRs as a share of all dwelling units in Vancouver, by local area (L) and dissemination area (R)_

While current STR activity is more concentrated Downtown, new STR growth is occurring in other areas. In Table \@ref(tab:tab-1-2), entries are orange if the area's value is higher than the City average, and blue if it is lower (TKTK NOT CURRENTLY IMPLEMENTED). The table reveals an overall inverse relationship between current STR activity and growth trends; while for example Downtown accounts for a plurality of existing listings and revenue, both listing and revenue growth is substantially higher in outlying areas (Marpole and Dunbar-Southlands, for example). This pattern points to an ongoing decentralization of STR activity in Vancouver. 

``` {r tab-1-2, include = TRUE}

library(kableExtra)

LA_breakdown %>% 
  select(area, active_listings, active_growth, listings_pct_dwellings,
         annual_rev, rev_growth) %>% 
  filter(active_listings > 100) %>% 
  arrange(-active_listings) %>% 
  mutate(active_listings = prettyNum(round(active_listings, -1), ","),
         active_growth = scales::percent(active_growth, 0.1),
         listings_pct_dwellings = scales::percent(listings_pct_dwellings, 0.1),
         annual_rev = scales::dollar(annual_rev, 0.1, scale = 1 / 1000000),
         rev_growth = scales::percent(rev_growth, 0.1)) %>%
  add_row(area = "City of Vancouver",
          active_listings = avg_listings_active,
          active_growth = paste0("-", active_yoy_listings),
          listings_pct_dwellings = {
            avg_listings_active %>% 
              parse_number() %>% 
              {. / sum(LA$dwellings)} %>% 
              scales::percent(0.1)},
          annual_rev = str_remove(annual_rev, " million"),
          rev_growth = active_yoy_revenue,
          .before = 1) %>% 
  set_names(c("Area", 
              "Active listings",
              "Annual listing growth",
              "Active listings as % of dwellings",
              "Annual revenue (million)",
              "Annual revenue growth")) %>% 
  kbl(caption = "Local areas with at least 100 daily active listings in 2019",
               align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") %>% 
  row_spec(1, background = paste0(col_palette[2], "50"))

  
```

<br>

## Listing types and sizes

STRs listed on Airbnb can be one of four types: entire homes or apartments, private rooms, shared rooms, and hotel rooms. We have excluded the latter from our analysis, since we focus only on STRs located in housing units. Most policy attention has been focused on entire-home listings, both because these listings are most likely to generate harmful negative externalities, including housing loss and neighbourhood nuisance, and because entire-home listings tend to be the most common. 

``` {r para_8, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

bedrooms <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% active_2019, listing_type == "Entire home/apt") %>% 
  mutate(bedrooms = if_else(bedrooms >= 3, "3+", as.character(bedrooms))) %>% 
  count(bedrooms) %>% 
  mutate(percentage = n / sum(n))

one_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "1") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

two_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "2") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

three_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "3+") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

studios <- 
  bedrooms %>% 
  filter(bedrooms == "0") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

eh_3_bedroom <- 
  property %>% 
  filter(housing, created <= LTM_end_date, scraped >= LTM_start_date, 
         listing_type == "Entire home/apt", !is.na(bedrooms)) %>% 
  st_drop_geometry() %>% 
  summarize(bed_3 = mean(bedrooms <= 3)) %>% 
  pull(bed_3) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

Table \@ref(tab:tab-1-3) provides the distribution of the listings by listing type in 2019. The majority of STRs in Vancouver are entire homes, a category which includes single-family homes, townhouses, apartments and condominiums. `r one_bedrooms` of these were one-bedroom housing units, and a third (`r two_bedrooms`) were two-bedrooms units. Almost a fifth of these listings (`r three_bedrooms`) were 3 or more bedrooms housing units, and `r studios` were studios. In general, studios and one-bedroom units are overrepresented on STR platforms in comparison with the City’s overall housing stock.

``` {r tab-1-3, include = TRUE}

library(kableExtra)

listing_type_breakdown %>%
  mutate(active_listings = prettyNum(round(active_listings, digits = -1), ","),
         revenue = scales::dollar(revenue, 0.1, 1 / 1000000),
         pct_of_listings = scales::percent(pct_of_listings, 0.1),
         pct_of_revenue = scales::percent(pct_of_revenue, 0.1),
         pct_listing_growth = scales::percent(pct_listing_growth, 0.1)) %>% 
  rename(`Listing type` = listing_type,
         `Active listings` = active_listings,
         `Annual revenue (million)` = revenue,
         `Share of all listings` = pct_of_listings,
         `Share of all revenue` = pct_of_revenue,
         `Annual listing growth` = pct_listing_growth
         ) %>% 
  kbl(caption = "Listing type prevalence in the City of Vancouver",
               align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down")

```

In 2019 entire-home listings accounted for `r eh_listings` of all daily active listings, and `r eh_revenue` of total host revenue. (Private rooms accounted for nearly all of the remainder.) Moreover, the dominance of entire-home listings in Vancouver’s STR market is increasing over time; while there were fewer active listings among all listing types in 2019 when compared to 2018, active daily entire-home listings declined by a much smaller proportion than the other listing types.

<br>

## Revenue distribution among STR hosts

A crucial concept for understanding the structure of an STR market is the distinction between casual STRs (“home sharing”) and dedicated STRs (“commercial operations”). One way to capture this distinction is to examine the distribution of revenue among STR hosts. Is revenue widely distributed between many part-time hosts of single listings, or concentrated among a small number of commercial operators who control many full-time listings?

While hosts are identified on Airbnb or VRBO with unique accounts, these accounts are not necessarily an accurate guide to the individuals or companies which operate STR listings, since a given person or group of people can create as many host accounts as they wish, and split their listings among these accounts. What may appear superficially as a large number of small STR operators could thus be in reality a much smaller number of operators controlling many accounts each. To address this possibility, we use custom image recognition software to identify identical photographs which are used across multiple listings, and thereby construct groups of host accounts which are either a single operator or a network of operators working in collaboration. If multiple, apparently separate host accounts use the identical photo on the webpages of their STR listings, this is very strong evidence that these accounts are 

``` {r para_9, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Host deciles table for figure
host_deciles <-
  daily %>%
  filter(housing, date >= LTM_start_date, date <= LTM_end_date, 
         status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price)) %>% 
  summarize(all = sum(rev),
            top_10 = sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_20 = sum(rev[rev > quantile(rev, c(0.80))] / all) - 
              sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_30 = sum(rev[rev > quantile(rev, c(0.70))] / all) - 
              sum(rev[rev > quantile(rev, c(0.80))] / all),
            top_40 = sum(rev[rev > quantile(rev, c(0.60))] / all) - 
              sum(rev[rev > quantile(rev, c(0.70))] / all),
            top_50 = sum(rev[rev > quantile(rev, c(0.50))] / all) - 
              sum(rev[rev > quantile(rev, c(0.60))] / all),
            top_60 = sum(rev[rev > quantile(rev, c(0.40))] / all) - 
              sum(rev[rev > quantile(rev, c(0.50))] / all),
            top_70 = sum(rev[rev > quantile(rev, c(0.30))] / all) - 
              sum(rev[rev > quantile(rev, c(0.40))] / all),
            top_80 = sum(rev[rev > quantile(rev, c(0.20))] / all) - 
              sum(rev[rev > quantile(rev, c(0.30))] / all),
            top_90 = sum(rev[rev > quantile(rev, c(0.10))] / all) - 
              sum(rev[rev > quantile(rev, c(0.20))] / all),
            top_100 = sum(rev[rev > quantile(rev, c(0.00))] / all) - 
              sum(rev[rev > quantile(rev, c(0.10))] / all)) %>% 
  select(-all) %>% 
  pivot_longer(everything(), names_to = "percentile", values_to = "value") %>% 
  mutate(percentile = factor(percentile, levels = paste0("top_", 1:10 * 10))) %>% 
  mutate(perfect_distribution = 0.1,
         decile = 1:10,
         dummy_1 = perfect_distribution,
         dummy_2 = value) %>%  
  rename("0" = perfect_distribution, "1" = value, "0.25" = dummy_1, 
         "0.75" = dummy_2) %>%
  pivot_longer(c("0","0.25", "0.75", "1"), names_to = "position") %>% 
  mutate(position = as.numeric(position),
         display_val = scales::percent(value, .1)) %>% 
  group_by(position) %>% 
  mutate(absolute_val = slide_dbl(value, ~{.x[1] / 2 + sum(.x[-1])}, 
                                  .after = 9)) %>% 
  ungroup() %>% 
  mutate(
    display_val = paste0("earned ", display_val, "\nof revenue"),
    display_percentile = case_when(
      percentile == "top_10" ~ "Top 10% of hosts...",
      percentile == "top_20" ~ "Next 10% of hosts...",
      TRUE ~ NA_character_))

top_host_listings <- 
  property %>% 
  filter(host_ID == host_rev[which.max(host_rev$rev),]$host_ID) %>% 
  nrow()

top_host_rev <- 
  host_rev %>% 
  filter(rev == max(rev)) %>% 
  pull(rev) %>% 
  scales::dollar(accuracy = 0.1, scale = 1 / 1000000, suffix = " million")

median_host_rev <- 
  median(host_rev$rev) %>%
  scales::dollar(accuracy = 100)

n_hosts_over_250 <- 
  host_rev %>% 
  filter(rev >= 250000) %>% 
  nrow()

host_rev_top_10 <- 
  host_rev %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_5 <- 
  host_rev %>% 
  summarize(top_5 = sum(rev[rev > quantile(rev, .95)]) / sum(rev)) %>% 
  pull(top_5) %>% 
  scales::percent(0.1)

host_rev_top_1 <- 
  host_rev %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

We identified one network of hosts which has operated `r top_host_listings` listings in Vancouver over the last several years, and which earned approximately `r top_host_rev` in 2019. An investigation into a sample of the host accounts which make up this network suggests links between numerous property management companies and third party operators. Through time, several individual host accounts seem to have merged into a cluster of larger hosts. The image-matching algorithm also merged hosts that use both Airbnb and VRBO, allowing for more accurate revenue calculations. Without interviewing actors associated with this host network, it is impossible to describe the level of connection and coordination between the various host accounts, but an operation of this scale would not be unprecedented. Reports from Chicago, USA and London, UK have identified similar host networks behind which were property management companies and realty groups (Conti, 2019). 

``` {r make_fig_1_4}

figure_1_4_fun <- function(regular = "", condensed = "") {
  
  revenue_colour <- colorRampPalette(col_palette[c(1, 3, 6, 4, 2, 5)])(10)

  host_deciles %>% 
  ggplot(aes(position, value, group = decile, fill = decile)) +
  geom_area(colour = "white", lwd = 1.2) +
  geom_text(aes(x = 0.02, y = absolute_val, label = display_percentile), 
            data = filter(host_deciles, position == 0, decile <= 2),
            family = regular, 
            hjust = 0) +
  geom_text(aes(x = 0.98, y = absolute_val, label = display_val), 
            data = filter(host_deciles, position == 1, decile <= 2),
            family = regular, 
            hjust = 1) +
  scale_y_continuous(name = "Host decile", label = scales::label_percent(1),
                     breaks = seq(0, 1, by = 0.1), limits = c(0, 1),
                     sec.axis = sec_axis(~., 
                                         name = "% of total revenue",
                                         labels = derive(), 
                                         breaks = derive())) +
  scale_fill_gradientn(colours = revenue_colour) +
  theme_void() +
  theme(legend.position = "none",
        text = element_text(family = regular),
        axis.text.y = element_text(hjust = 1),
        axis.title.y.left = element_text(
          angle = 90, margin = margin(0, 10, 0, 0)),
        axis.title.y.right = element_text(
          angle = 270, margin = margin(0, 0, 0, 10)),
        axis.title.x = element_blank(), 
        axis.text.x = element_blank())

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_4.pdf"), 
         plot = figure_1_4_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_4.pdf"))
}

```

Among all the STR hosts who earned revenue in the City of Vancouver last year, the median revenue was `r median_host_rev` (Table \@ref(tab:tab-host-rev)). Throughout the City of Vancouver, there were `r n_hosts_over_250` hosts that earned more than $250,000 in 2019. Figure \@ref(fig:fig-1-4) shows the percentage of the total `r annual_rev` in STR revenue which accrued to each decile of hosts. The figure shows that revenue is disproportionately concentrated among a small number of hosts; the top 10% earned `r host_rev_top_10`: the top 5% earned `r host_rev_top_5` of revenue, while the top 1% of hosts earned `r host_rev_top_1` of all revenue. As high as these numbers are, however, they are lower than other large cities in Canada. Montreal’s top 10% of STR hosts earned 68.8% of all revenue in 2019, for example. This indicates that Vancouver's STR market is less dominated by commercial operators than that of its peer cities.

``` {r tab-host-rev, include = TRUE}

library(kableExtra)

host_rev %>% 
  pull(rev) %>% 
  quantile() %>% 
  as.list() %>% 
  as_tibble() %>% 
  select(-`0%`) %>% 
  set_names(c("25th percentile", "Median", "75th percentile", 
              "100th percentile")) %>% 
  mutate(across(1:3, scales::dollar, accuracy = 1000, big.mark = ",")) %>% 
  mutate(`100th percentile` = scales::dollar(`100th percentile`, 0.1, 
                                             scale = 1 / 1000000, 
                                             suffix = " million")) %>% 
  pivot_longer(everything(), names_to = "Host percentile", 
               values_to = "Annual revenue") %>% 
  kbl(caption = "Vancouver STR host revenue", align = "lr") %>% 
  kable_styling()

```

``` {r fig-1-4, include = TRUE, fig.cap = '(ref:fig-1-4)', fig.align = "center"}

figure_1_4_fun()

```

(ref:fig-1-4) _STR host revenue distribution in the City of Vancouver_

<br>

## The commercialization of Vancouver’s STR market

Some hosts operate multiple STR units, which can be an indication of a commercial operator rather than a casual home sharer. To take the simplest case, for example, a host with two or more entire-home listings on the same day cannot be operating both listings out of their principal residence, regardless of the frequency they are rented throughout the year. This means that these operators are not respecting the by-law, which prevents a person from operating a STR outside their principal residence.

We consider entire-homes to be "multilistings" if they are operated by hosts who are simultaneously operating other entire-home listings. We define private-room multilistings as cases where a host has three or more private-room listings operating on the same day. Since `r eh_3_bedroom` of entire-home listings have three or fewer bedrooms, there will be extremely few cases where a host operating three private-room STR listings in a dwelling unit has not converted the entire unit into a dedicated STR. Intuitively, multilistings that are still operating since the City's STR regulations were enacted in April 2018 are almost certainly non-compliant. In particular, it is impossible for a host holding five listings to be operating them all out of their principal residence, which is one of the regulation’s requirements.

``` {r para_10, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# ML table for figure
ML <- 
  daily %>% 
  filter(status != "B") %>% 
  group_by(date) %>% 
  summarize(Listings = mean(multi),
            Revenue = sum(price[status == "R" & multi], na.rm = TRUE) / 
              sum(price[status == "R"], na.rm = TRUE)) %>% 
  mutate(across(where(is.numeric), slide_dbl, mean, .before = 13)) %>% 
  pivot_longer(c(Listings, Revenue), names_to = "Multilisting percentage",
               values_to = "value")

rm(property, daily, GH)

```

``` {r make_fig_1_5}

figure_1_5_fun <- function(regular = "", condensed = "") {
  
  ML %>% 
    filter(date >= "2017-01-01") %>% 
    ggplot() +
    geom_line(aes(date, value, colour = `Multilisting percentage`), lwd = 1) +
    annotate("segment", x = key_date_covid, xend = key_date_covid,
             y = -Inf, yend = Inf, alpha = 0.3) +
    annotate("segment", x = key_date_regulations, xend = key_date_regulations,
             y = -Inf, yend = Inf, alpha = 0.3) +
    scale_y_continuous(name = NULL, 
                       label = scales::percent_format(accuracy = 1)) +
    scale_colour_manual(values = col_palette[c(5, 1)]) +
    theme_minimal() +
    theme(legend.position = "bottom",
          panel.grid.minor.x = element_blank(),
          text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold"),
          legend.text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_5.pdf"), 
         plot = figure_1_5_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_5.pdf"))
}

```

In 2019, `r ml_listings` of active listings in Vancouver were multilistings, earning `r ml_revenue` of total host revenue. Multilistings had been growing steadily since 2017, both in terms of listings and revenue percentage, until Airbnb’s mass removal of listings without licence numbers. Since then, the proportion of multilistings and their share of overall revenue has been decreasing. Multilisting revenue as a share of total revenue reached an all-time high right before Airbnb's August 2018 regulatory enforcement takedown, while multilisting active listings as a share of total active listings peaked several months later (Figure \@ref(fig:fig-1-5)). Both indicators have been in relatively steady decline since then, and by the end of 2019 were considerably lower than in any of the other large cities in Canada. Figure \@ref(fig:fig-1-5) also highlights that, amidst generally declining STR activity during the COVID-19 pandemic, multilistings have declined disproportionately quickly, and through the fall of 2020 were earning a bit more than 1 out of every 4 dollars on STR platforms in Vancouver. 

``` {r fig-1-5, include = TRUE, fig.cap = '(ref:fig-1-5)', fig.align = "center"}

figure_1_5_fun()

```

(ref:fig-1-5) _The percentage of active listings and revenue accounted for by multilistings in Vancouver (14-day average)_

These figures should be taken as highly conservative estimates. Many commercial operators will use different Airbnb or VRBO accounts to manage their listings. If multiple listings share the same photographs then our image recognition software will be able to connect them together, but it is otherwise difficult to determine whether two accounts belong to the same person. Moreover, many STR commercial operators only operate a single listing, but operate it on a full-time basis. A house owner with a secondary suite, or the owner of an investment condo who operates a STR in it, are clearly commercial operators running listings which are not their principal residences, but they would not be counted by this method.

\newpage
