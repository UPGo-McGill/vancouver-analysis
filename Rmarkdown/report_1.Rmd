---
title: "1. Short-term rentals in the City of Vancouver: Market overview and housing impacts"
output: html_document
---

```{r setup, include = FALSE, echo = FALSE}

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

library(here)
source(here("R", "01_startup.R"))
qload(here("output", "str_processed.qsm"), nthreads = availableCores())

```

*TKTK executive summary*

```{r new_objects, cache = TRUE}

# 2019 active
active_2019 <- 
  daily %>%
  filter(housing, status %in% c("R", "A"), date <= LTM_end_date, 
         date >= LTM_start_date) %>%
  pull(property_ID) %>% 
  unique()
  
# 2019 revenue
revenue_2019 <-
  daily %>%
  filter(housing, status == "R", date <= LTM_end_date, 
         date >= LTM_start_date) %>%
  group_by(property_ID) %>%
  summarize(revenue_LTM = sum(price), .groups = "drop") %>% 
  inner_join(property, ., by = "property_ID")

# Active listings
active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date, listing_type) %>% 
  group_by(listing_type) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup()

active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE),
         listing_type = "All listings") %>% 
  bind_rows(active_listings) %>% 
  arrange(date, listing_type)


```

## 1.1 Active daily listings and annual revenue

```{r para_1, cache = TRUE}

# Average active and blocked daily listings in 2019
avg_listings <- 
  daily %>% 
  filter(housing, date >= LTM_start_date, date <= LTM_end_date) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active <- 
  avg_listings$avg[1] %>% 
  prettyNum(",")

# Average number of hosts (taking out blocked 365 days)
avg_hosts <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date, 
         date <= LTM_end_date) %>%
  count(date, host_ID) %>% 
  count(date) %>% 
  summarize(hosts = round(mean(n), digit = -1), .groups = "drop") %>% 
  pull(hosts) %>% 
  prettyNum(",")

# Total annual revenue
annual_rev <- 
  revenue_2019$revenue_LTM %>% 
  sum() %>% 
  {. / 1000000} %>% 
  round(digit = 1) %>% 
  prettyNum(",") %>% 
  paste0("$", ., " million")

# Average revenue per active listing
avg_rev_per_listing <- 
  (sum(revenue_2019$revenue_LTM) /
    daily %>% 
    filter(housing, status != "B", date >= LTM_start_date, 
           date <= LTM_end_date) %>% 
    count(date) %>% 
    summarize(avg_rev_per_active = round(mean(n)), .groups = "drop")) %>% 
  as.vector() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

#' Average revenue per active host
avg_rev_per_host <- 
  (sum(revenue_2019$revenue_LTM) /
    daily %>% 
    filter(housing, status != "B", date >= LTM_start_date, 
           date <= LTM_end_date) %>%
    group_by(date) %>% 
    summarize(n_hosts = length(unique(host_ID)), .groups = "drop_last") %>% 
    summarize(avg_n_hosts = round(mean(n_hosts)), .groups = "drop")) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

```

Active daily listings are listings which were displayed on Airbnb or VRBO on a given day, and were either reserved or available for a reservation. It is the most reliable means of determining the overall size of the STR market in a location, particularly with respect to change over time. In 2019 there was an average of `r avg_listings_active` active daily listings (Figure 2.1) operated by an average of `r avg_hosts` hosts. These hosts collectively earned `r annual_rev`—an average of `r avg_rev_per_listing` per daily active listing or `r avg_rev_per_host` per active host.

``` {r para_2, cache = TRUE}

# Average blocked daily listings in 2019
avg_listings_blocked <- 
  avg_listings$avg[2] %>% 
  prettyNum(",")

# Average revenue per all listings
avg_revenue_all_listings <- 
  revenue_2019$revenue_LTM %>% 
  mean() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per all hosts
avg_revenue_all_hosts <- 
  revenue_2019 %>% 
  st_drop_geometry() %>%
  filter(!is.na(host_ID)) %>%
  group_by(host_ID) %>% 
  summarize("host_rev" = sum(revenue_LTM)) %>% 
  summarize("avg_host_rev" = prettyNum(round(mean(host_rev), digit = -2), ",")) %>% 
  pull(avg_host_rev) %>% 
  paste0("$", .)

#' [8] Non-housing active listings
non_housing_listings <- 
  daily %>% 
  filter(!housing, status != "B", date >= LTM_start_date, 
         date <= LTM_end_date) %>%
  count(date) %>% 
  summarize(non_housing = round(mean(n), digit = -1)) %>% 
  pull(non_housing) %>% 
  prettyNum(",")

```

There was also a daily average of `r avg_listings_blocked` listings which were visible on the Airbnb and VRBO websites but were blocked by the host from receiving reservations. The presence of these listings can erroneously suggest that a city’s STR market is larger than it is. When these blocked but inactive listings are included, the average listing earned `r avg_revenue_all_listings` last year, and the average host earned `r avg_revenue_all_hosts`. Finally, there was a daily average of `r non_housing_listings` listings that were not located in private housing units (B&Bs, hotels, etc.), which have been excluded from the analysis in this report. All the figures which follow, therefore, pertain to short-term rentals located in Vancouver’s traditional residential housing stock.

``` {r para_3, cache = TRUE}

# Date and amount of highest activity
highest_activity <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  filter(n == max(n)) %>% 
  group_by(date) %>% 
  summarize(daily_max = round((n), digit = -1))

highest_activity_date <-
  highest_activity$date %>% 
  {paste0(month.name[as.numeric(substr(., 6, 7))], " ", substr(., 1, 4))}

highest_activity_amount <- 
  highest_activity$daily_max %>% 
  prettyNum(",")

# Active listing YOY change
active_yoy_change <- 
  daily %>% 
  filter(housing, status != "B", date >= LTM_start_date - years(1), 
         date <= LTM_end_date) %>% 
  group_by(year_2019 = date >= LTM_start_date) %>% 
  summarize(active_listings = n() / 365,
            revenue = sum(price[status == "R"]), .groups = "drop") %>% 
  summarize(across(c(active_listings, revenue), ~{(.x[2] - .x[1]) / .x[1]}),
            .groups = "drop")

active_yoy_listings <- 
  active_yoy_change$active_listings %>% 
  {. * -1} %>% 
  scales::percent(accuracy = 0.1)

active_yoy_revenue <- 
  active_yoy_change$revenue %>% 
  scales::percent(accuracy = 0.1)


```

Active daily listings peaked in `r highest_activity_date` at `r highest_activity_amount`, and have since declined. There were  `r active_yoy_listings` fewer listings active on average in 2019 than in 2018. However, host revenue followed the opposite pattern, increasing by `r_active_yoy_revenue` between 2018 and 2019. The regulations succeeded in reducing the number of active listings, however listings which remained on the platforms are earning a slightly higher revenue than during the previous year.

``` {r make_fig_1_1, cache = TRUE}

figure_1_1_fun <- function(regular = "", condensed = "") {
  
  active_listings %>% 
  ggplot(aes(date, n, colour = listing_type, size = listing_type)) +
  annotate("segment", x = key_date_covid, xend = key_date_covid,
           y = -Inf, yend = Inf, alpha = 0.3) +
  annotate("curve", x = as.Date("2019-08-01"), xend = key_date_covid - days(10),
           y = 5000, yend = 4700, curvature = -.2, lwd = 0.25,
           arrow = arrow(length = unit(0.05, "inches"))) +
  annotate("text", x = as.Date("2019-05-01"), y = 5000,
           label = "COVID-19 \nAirbnb's response", family = condensed) +
  annotate("segment", x = key_date_regulations, xend = key_date_regulations,
           y = -Inf, yend = Inf, alpha = 0.3) +
  annotate("curve", x = as.Date("2018-06-01"), xend = key_date_regulations - days(10),
           y = 5200, yend = 5100, curvature = -.2, lwd = 0.25,
           arrow = arrow(length = unit(0.05, "inches"))) +
  annotate("text", x = as.Date("2018-02-01"), y = 5200,
           label = "Regulations", family = condensed)+
  geom_line() +
  scale_y_continuous(name = NULL, label = scales::comma) +
  scale_x_date(name = NULL, limits = c(as.Date("2016-01-01"), NA)) +
  scale_colour_manual(name = NULL, values = col_palette[c(5, 1:3)],
                      guide = guide_legend(
                        override.aes = list(size = c(1.5, 0.75, 0.75, 0.75)))) +
  scale_size_manual(values = c("All listings" = 1.5, "Entire home/apt" = 0.75,
                               "Private room" = 0.75, "Shared room" = 0.75),
                    guide = "none") +
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

ggsave(here("output", "figures", "figure_1_1.pdf"), 
       plot = figure_1_1_fun("Futura", "Futura Condensed"), 
       width = 8, height = 5, units = "in", useDingbats = FALSE)

extrafont::embed_fonts(here("output", "figures", "figure_1_1.pdf"))

```

In general, the number of STR listings available in the City of Vancouver peaks during late summer and winter holidays and falling in between these periods (Figure 1.1). There are two major exceptions to this pattern: the sharp drop in activity in the second half of 2018 after the City's STR regulations began to be enforced, and the March to September 2020 period, where activity has been sharply below the seasonal trend because of the COVID-19 pandemic.

``` {r fig_1, include = TRUE, fig.cap = "Figure 1. Active daily STRs in the City of Vancouver (7-day moving average)", cache = TRUE}

figure_1_1_fun()

```
