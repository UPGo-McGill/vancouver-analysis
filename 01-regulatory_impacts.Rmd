# Short-term rentals in Vancouver: Regulatory impacts

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```

```{r new_objects, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())

displayed_listings <-
  daily %>% 
  filter(housing) %>% 
  count(date, blocked = status == "B") %>% 
  group_by(blocked) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  group_by(date) %>% 
  mutate(n = if_else(blocked == TRUE, sum(n), n)) %>% 
  ungroup() %>% 
  mutate(blocked = if_else(blocked == TRUE, "Displayed listings", 
                           "Active listings"))

displayed_listings_all <-
  daily_all %>% 
  filter(housing) %>% 
  count(date, min_30 = minimum_stay >= 30, blocked = status == "B") %>% 
  group_by(min_30, blocked) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  group_by(date, min_30) %>% 
  mutate(n = if_else(blocked == TRUE, sum(n), n)) %>% 
  ungroup() %>% 
  mutate(blocked = if_else(blocked == TRUE, "Displayed listings", 
                           "Active listings"))

active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date, listing_type) %>% 
  group_by(listing_type) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup()

active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE),
         listing_type = "All listings") %>% 
  bind_rows(active_listings) %>% 
  arrange(date, listing_type)

active_listings_all <- 
  daily_all %>% 
  filter(housing, status != "B") %>% 
  count(date, listing_type) %>% 
  group_by(listing_type) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup()

active_listings_all <- 
  daily_all %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE),
         listing_type = "All listings") %>% 
  bind_rows(active_listings_all) %>% 
  arrange(date, listing_type)

rm(property, daily, GH, DA, BL, BL_expanded, skytrain)

```

```{r trajectory, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

# Absolute drop in displayed listings
displayed_drop <- 
  displayed_listings %>% 
  filter(date >= "2018-08-20", date <= "2018-09-07", blocked == "Displayed listings") %>% 
  summarize(decline = max(n) - min(n)) %>% 
  pull(decline) %>% 
  scales::comma(10)

# Percentage drop in displayed listings
displayed_drop_pct <- 
  displayed_listings %>% 
  filter(date >= "2018-08-20", date <= "2018-09-07") %>% 
  group_by(blocked) %>% 
  summarize(decline = 1 - min(n) / max(n)) %>% 
  filter(blocked == "Displayed listings") %>% 
  pull(decline) %>% 
  scales::percent(0.1)

# Absolute drop in active listings
active_drop <- 
  displayed_listings %>% 
  filter(date >= "2018-08-20", date <= "2018-09-07", blocked == "Active listings") %>% 
  summarize(decline = max(n) - min(n)) %>% 
  pull(decline) %>% 
  scales::comma(10)

# Drop in active listings
active_drop_pct <- 
  displayed_listings %>% 
  filter(date >= "2018-08-20", date <= "2018-09-07") %>% 
  group_by(blocked) %>% 
  summarize(decline = 1 - min(n) / max(n)) %>% 
  filter(blocked == "Active listings") %>% 
  pull(decline) %>% 
  scales::percent(0.1)

```

```{r project_seasonal_fun}

project_seasonal <- function(daily, start_proj, n_months,
                             data_start = as.Date(start_proj) - years(3)) {
  
  start_proj <- as.Date(start_proj)
  
  # Get seasonal trend components
  active_components <- 
    daily %>% 
    count(date) %>% 
    tsibble::as_tsibble() %>% 
    tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
    summarize(n = sum(n, na.rm = TRUE)) %>% 
    filter(yearmon >= tsibble::yearmonth(data_start)) %>%
    filter(yearmon <= tsibble::yearmonth(start_proj - months(1))) %>%
    model(x11 = feasts:::X11(n, type = "additive")) %>% 
    components()
  
  # Get linear trend from last two years
  active_linear_coefficients <- 
    active_components %>% 
    filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
    mutate(id = 1:24) %>% 
    lm(trend ~ id, data = .) %>% 
    `$`("coefficients")
  
  # Get seasonal component for last year
  active_seasonal <- 
    active_components %>% 
    filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
    mutate(month = lubridate::month(yearmon)) %>% 
    slice_tail(n = 12) %>% 
    as_tibble() %>% 
    select(month, seasonal)
  
  # Build monthly projections
  active_monthly_projection <-
    tibble(
      id = 24 + seq_len(n_months),
      yearmon = seq(tsibble::yearmonth(start_proj), 
                    length.out = n_months, by = 1),
      month = lubridate::month(yearmon),
      trend_growth = 
        active_linear_coefficients[[1]] + id * active_linear_coefficients[[2]],
      trend_no_growth = 
        active_linear_coefficients[[1]] + 24 * active_linear_coefficients[[2]]
    ) %>% 
    left_join(active_seasonal, by = "month") %>% 
    mutate(projected_growth = trend_growth + seasonal,
           projected_no_growth = trend_no_growth + seasonal)
  
  # Convert to daily values for month midpoints
  active_daily_projection <-
    active_monthly_projection %>% 
    mutate(days = days_in_month(month),
           date = as.Date(yearmon) + 15,
           projected_growth = round(projected_growth / days),
           projected_no_growth = round(projected_no_growth / days)) %>% 
    select(date, projected_growth, projected_no_growth)
  
  # Integrate into actual data
  active_listings_trend <- 
    daily %>% 
    count(date) %>% 
    mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
    left_join(active_daily_projection) %>% 
    mutate(projected_growth = if_else(date == start_proj, n, projected_growth),
           projected_no_growth = if_else(date == start_proj, 
                                         n, projected_no_growth)) %>%
    filter(date >= start_proj, 
           date <= start_proj + months(n_months - 1) + days(15)) %>%
    mutate(projected_growth = zoo::na.approx(projected_growth),
           projected_no_growth = zoo::na.approx(projected_no_growth))
  
  # Rbind with previous data
  active_listings_trend <- 
    daily %>% 
    count(date) %>% 
    mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
    filter(date < start_proj) %>% 
    bind_rows(active_listings_trend)
  
  return(active_listings_trend)
}

```

```{r active_trend, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "cma_comparison.qsm"), nthreads = availableCores())
library(feasts)
library(fabletools)

start_proj <- as.Date("2018-04-01")
n_months <- 21
data_start <- as.Date(start_proj) - months(40)
  
# Get seasonal trend components
active_components <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(n, na.rm = TRUE)) %>% 
  filter(yearmon >= tsibble::yearmonth(data_start)) %>%
  filter(yearmon <= tsibble::yearmonth(start_proj - months(1))) %>%
  model(X_13ARIMA_SEATS(n)) %>% 
  components()

# Get linear trend from last two years
active_linear_coefficients <- 
  active_components %>% 
  filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
  mutate(id = 1:24) %>% 
  lm(trend ~ id, data = .) %>% 
  `$`("coefficients")
  
# Get seasonal component for last year
active_seasonal <- 
  active_components %>% 
  filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
  mutate(month = lubridate::month(yearmon)) %>% 
  slice_tail(n = 12) %>% 
  as_tibble() %>% 
  select(month, seasonal)

# Get Toronto seasonal trend components
active_components_to <- 
  daily_toronto %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(n, na.rm = TRUE)) %>% 
  filter(yearmon >= tsibble::yearmonth("2016-11-01")) %>%
  filter(yearmon <= tsibble::yearmonth(as.Date("2020-02-01"))) %>%
  model(X_13ARIMA_SEATS(n)) %>% 
  components()

# Get Toronto linear trend post-regulation
active_linear_coefficients_to <- 
  active_components_to %>% 
  filter(yearmon >= tsibble::yearmonth("2018-04-01")) %>% 
  mutate(id = 1:23) %>% 
  lm(trend ~ id, data = .) %>% 
  `$`("coefficients")

# Build monthly projections
active_monthly_projection <-
  tibble(
  id = 24 + seq_len(n_months),
  yearmon = seq(tsibble::yearmonth(start_proj), 
                length.out = n_months, by = 1),
  month = lubridate::month(yearmon),
  trend_growth = 
    active_linear_coefficients[1] + id * active_linear_coefficients[2],
  trend_no_growth = 
    active_linear_coefficients[1] + 24 * active_linear_coefficients[2],
  trend_toronto =
    active_linear_coefficients[1] + 24 * active_linear_coefficients[2] + 
    (id - 24) * active_linear_coefficients_to[2] * 
    (active_linear_coefficients[1] / active_linear_coefficients_to[1])) %>% 
  left_join(active_seasonal, by = "month") %>% 
  mutate(projected_growth = trend_growth + seasonal,
         projected_no_growth = trend_no_growth + seasonal,
         projected_toronto = trend_toronto + seasonal)

# Convert to daily values for month midpoints
active_daily_projection <-
  active_monthly_projection %>% 
  mutate(days = days_in_month(month),
         date = as.Date(yearmon) + 15,
         projected_growth = round(projected_growth / days),
         projected_no_growth = round(projected_no_growth / days),
         projected_toronto = round(projected_toronto / days)) %>% 
  select(date, projected_growth, projected_no_growth, projected_toronto)

# Integrate into actual data
active_listings_trend <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  left_join(active_daily_projection) %>% 
  mutate(projected_growth = if_else(date == start_proj, n, projected_growth),
         projected_no_growth = if_else(date == start_proj, 
                                       n, projected_no_growth),
         projected_toronto = if_else(date == start_proj, n, 
                                     projected_toronto)) %>%
  filter(date >= start_proj, 
         date <= start_proj + months(n_months - 1) + days(15)) %>%
  mutate(projected_growth = zoo::na.approx(projected_growth),
         projected_no_growth = zoo::na.approx(projected_no_growth),
         projected_toronto = zoo::na.approx(projected_toronto))

# Rbind with previous data
active_listings_trend <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  filter(date < start_proj) %>% 
  bind_rows(active_listings_trend)
  
# Listing differences
listing_difs <- 
  active_listings_trend %>% 
  filter(date >= "2019-07-01") %>% 
  mutate(growth_df = projected_growth - n,
         no_growth_df = projected_no_growth - n,
         toronto_df = projected_toronto - n) %>% 
  summarize(avg_n = mean(n),
            avg_growth = mean(growth_df),
            avg_growth_pct = avg_growth / avg_n,
            avg_no_growth = mean(no_growth_df),
            avg_no_growth_pct = avg_no_growth / avg_n,
            avg_toronto = mean(toronto_df),
            avg_toronto_pct = avg_toronto / avg_n)

growth_dif <- 
  listing_difs %>% 
  pull(avg_growth) %>% 
  round(-1) %>% 
  prettyNum(",")

growth_dif_pct <- 
  listing_difs %>% 
  pull(avg_growth_pct) %>% 
  scales::percent(0.1)

no_growth_dif <- 
  listing_difs %>% 
  pull(avg_no_growth) %>% 
  round(-1) %>% 
  prettyNum(",")

no_growth_dif_pct <- 
  listing_difs %>% 
  pull(avg_no_growth_pct) %>% 
  scales::percent(0.1)

toronto_dif <- 
  listing_difs %>% 
  pull(avg_toronto) %>% 
  round(-1) %>% 
  prettyNum(",")

toronto_dif_pct <- 
  listing_difs %>% 
  pull(avg_toronto_pct) %>% 
  scales::percent(0.1)

rm(property_montreal, property_toronto, property, daily, daily_montreal, 
   daily_toronto, property_montreal_other, property_toronto_other,
   daily_montreal_other, daily_toronto_other, GH)
```

```{r multi_trend, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "cma_comparison.qsm"), nthreads = availableCores())
library(feasts)
library(fabletools)

commercial_listings <- 
  daily %>% 
  filter(status != "B", date >= "2015-01-01") %>% 
  mutate(commercial = if_else(FREH_3 < 0.5 & !multi, FALSE, TRUE)) %>% 
  count(date, commercial) %>% 
  ungroup()

start_proj <- as.Date("2018-04-01")
n_months <- 21
data_start <- as.Date(start_proj) - years(3)

multi_listings <- 
  daily %>% 
  filter(housing, multi, status != "B") %>% 
  count(date)

multi_listings_to <- 
  daily_toronto %>% 
  filter(housing) %>% 
  group_by(date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE))
  
# Get seasonal trend components
multi_components <- 
  daily %>% 
  filter(housing, multi, status != "B") %>% 
  count(date) %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(n, na.rm = TRUE)) %>% 
  filter(yearmon >= tsibble::yearmonth(data_start - months(2))) %>%
  filter(yearmon <= tsibble::yearmonth(start_proj - months(1))) %>%
  model(X_13ARIMA_SEATS(n)) %>% 
  components()

# Get linear trend from last two years
multi_coefficients <- 
  multi_components %>% 
  filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
  mutate(id = 1:24) %>% 
  lm(trend ~ id, data = .) %>% 
  `$`("coefficients")

# Get seasonal component for last year
multi_seasonal <- 
  multi_components %>% 
  filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
  mutate(month = lubridate::month(yearmon)) %>% 
  slice_tail(n = 12) %>% 
  as_tibble() %>% 
  select(month, seasonal)

# Get Toronto seasonal trend components
multi_components_to <- 
  daily_toronto %>% 
  filter(housing, multi, status != "B") %>% 
  count(date) %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(n, na.rm = TRUE)) %>% 
  filter(yearmon >= tsibble::yearmonth("2016-11-01")) %>%
  filter(yearmon <= tsibble::yearmonth(as.Date("2020-02-01"))) %>%
  model(X_13ARIMA_SEATS(n)) %>% 
  components()

# Get Toronto linear trend post-regulation
multi_coefficients_to <- 
  multi_components_to %>% 
  filter(yearmon >= tsibble::yearmonth("2018-04-01")) %>% 
  mutate(id = 1:23) %>% 
  lm(trend ~ id, data = .) %>% 
  `$`("coefficients")

# Build monthly projections
multi_monthly_projection <-
  tibble(
    id = 24 + seq_len(n_months),
    yearmon = seq(tsibble::yearmonth(start_proj), 
                  length.out = n_months, by = 1),
    month = lubridate::month(yearmon),
    trend_growth = multi_coefficients[1] + id * multi_coefficients[2],
    trend_no_growth = multi_coefficients[1] + 24 * multi_coefficients[2],
    trend_toronto = multi_coefficients[1] + 24 * multi_coefficients[2] + 
      (id - 24) * multi_coefficients_to[2] * 
      (multi_coefficients[1] / multi_coefficients_to[1])) %>% 
  left_join(multi_seasonal, by = "month") %>% 
  mutate(projected_growth = trend_growth + seasonal,
         projected_no_growth = trend_no_growth + seasonal,
         projected_toronto = trend_toronto + seasonal)

# Convert to daily values for month midpoints
multi_daily_projection <-
  multi_monthly_projection %>% 
  mutate(days = days_in_month(month),
         date = as.Date(yearmon) + 15,
         projected_growth = round(projected_growth / days),
         projected_no_growth = round(projected_no_growth / days),
         projected_toronto = round(projected_toronto / days)) %>% 
  select(date, projected_growth, projected_no_growth, projected_toronto)

# Integrate into actual data
multi_listings_trend <- 
  daily %>% 
  filter(housing, multi, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  left_join(multi_daily_projection) %>% 
  mutate(projected_growth = if_else(date == start_proj, n, projected_growth),
         projected_no_growth = if_else(date == start_proj, 
                                       n, projected_no_growth),
         projected_toronto = if_else(date == start_proj, n, 
                                     projected_toronto)) %>%
  filter(date >= start_proj, 
         date <= start_proj + months(n_months - 1) + days(15)) %>%
  mutate(projected_growth = zoo::na.approx(projected_growth),
         projected_no_growth = zoo::na.approx(projected_no_growth),
         projected_toronto = zoo::na.approx(projected_toronto))

# Rbind with previous data
multi_listings_trend <- 
  daily %>% 
  filter(housing, multi, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  filter(date < start_proj) %>% 
  bind_rows(multi_listings_trend)

# Listing differences
multi_listing_difs <- 
  multi_listings_trend %>% 
  filter(date >= "2019-07-01") %>% 
  mutate(growth_df = projected_growth - n,
         no_growth_df = projected_no_growth - n,
         toronto_df = projected_toronto - n) %>% 
  summarize(avg_n = mean(n),
            avg_growth = mean(growth_df),
            avg_growth_pct = avg_growth / avg_n,
            avg_no_growth = mean(no_growth_df),
            avg_no_growth_pct = avg_no_growth / avg_n,
            avg_toronto = mean(toronto_df),
            avg_toronto_pct = avg_toronto / avg_n)

multi_growth_dif <- 
  multi_listing_difs %>% 
  pull(avg_growth) %>% 
  round(-1) %>% 
  prettyNum(",")

multi_growth_dif_pct <- 
  multi_listing_difs %>% 
  pull(avg_growth_pct) %>% 
  scales::percent(0.1)

multi_no_growth_dif <- 
  multi_listing_difs %>% 
  pull(avg_no_growth) %>% 
  round(-1) %>% 
  prettyNum(",")

multi_no_growth_dif_pct <- 
  multi_listing_difs %>% 
  pull(avg_no_growth_pct) %>% 
  scales::percent(0.1)

multi_toronto_dif <- 
  multi_listing_difs %>% 
  pull(avg_toronto) %>% 
  round(-1) %>% 
  prettyNum(",")

multi_toronto_dif_pct <- 
  multi_listing_difs %>% 
  pull(avg_toronto_pct) %>% 
  scales::percent(0.1)

# Commercial properties removed
taken_down_properties <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(scraped >= "2018-08-23", scraped <= "2018-08-31") %>% 
  pull(property_ID)

commercial_pct_removed <- 
  {{
    daily %>% 
      filter(housing, 
             property_ID %in% taken_down_properties,
             date >= key_date_regulations,
             FREH_3 >= 0.5 | multi) %>% 
      distinct(property_ID) %>% 
      nrow()
    } / {
      commercial_listings %>% 
        filter(date == key_date_regulations, commercial) %>% 
        pull(n)
      }} %>% 
  scales::percent(0.1)

# Peak commercial listings in 2019
peak_2019_commercial <- 
  commercial_listings %>% 
  filter(commercial, date >= "2019-01-01", date <= "2019-12-31") %>% 
  filter(n == max(n)) %>% 
  pull(n) %>% 
  round(-1) %>% 
  prettyNum(",")

rm(property_montreal, property_toronto, property, daily, daily_montreal, 
   daily_toronto, property_montreal_other, property_toronto_other,
   daily_montreal_other, daily_toronto_other, GH)

```

```{r FREH_trend, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "cma_comparison.qsm"), nthreads = availableCores())
library(feasts)
library(fabletools)

start_proj <- as.Date("2018-04-01")
n_months <- 21
data_start <- as.Date(start_proj) - years(3)

FREH_listings <- 
  daily %>% 
  filter(housing) %>% 
  group_by(date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE))

FREH_listings_to <- 
  daily_toronto %>% 
  filter(housing) %>% 
  group_by(date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE))
  
# Get seasonal trend components
FREH_components <- 
  FREH_listings %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(n, na.rm = TRUE)) %>% 
  filter(yearmon >= tsibble::yearmonth(data_start)) %>%
  filter(yearmon <= tsibble::yearmonth(start_proj - months(1))) %>%
  model(x11 = feasts:::X11(n, type = "additive")) %>% 
  components()

# Get linear trend from last two years
FREH_coefficients <- 
  FREH_components %>% 
  filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
  mutate(id = 1:24) %>% 
  lm(trend ~ id, data = .) %>% 
  `$`("coefficients")

# Get seasonal component for last year
FREH_seasonal <- 
  FREH_components %>% 
  filter(yearmon >= tsibble::yearmonth(start_proj - years(2))) %>% 
  mutate(month = lubridate::month(yearmon)) %>% 
  slice_tail(n = 12) %>% 
  as_tibble() %>% 
  select(month, seasonal)

# Get Toronto seasonal trend components
FREH_components_to <- 
  FREH_listings_to %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(n, na.rm = TRUE)) %>% 
  filter(yearmon >= tsibble::yearmonth("2016-11-01")) %>%
  filter(yearmon <= tsibble::yearmonth(as.Date("2020-02-01"))) %>%
  model(x11 = feasts:::X11(n, type = "additive")) %>% 
  components()

# Get Toronto linear trend post-regulation
FREH_coefficients_to <- 
  FREH_components_to %>% 
  filter(yearmon >= tsibble::yearmonth("2018-04-01")) %>% 
  mutate(id = 1:23) %>% 
  lm(trend ~ id, data = .) %>% 
  `$`("coefficients")

# Build monthly projections
FREH_monthly_projection <-
  tibble(
    id = 24 + seq_len(n_months),
    yearmon = seq(tsibble::yearmonth(start_proj), 
                  length.out = n_months, by = 1),
    month = lubridate::month(yearmon),
    trend_growth = FREH_coefficients[1] + id * FREH_coefficients[2],
    trend_no_growth = FREH_coefficients[1] + 24 * FREH_coefficients[2],
    trend_toronto = FREH_coefficients[1] + 24 * FREH_coefficients[2] + 
      (id - 24) * FREH_coefficients_to[2] * 
      (FREH_coefficients[1] / FREH_coefficients_to[1])) %>% 
  left_join(FREH_seasonal, by = "month") %>% 
  mutate(projected_growth = trend_growth + seasonal,
         projected_no_growth = trend_no_growth + seasonal,
         projected_toronto = trend_toronto + seasonal)

# Convert to daily values for month midpoints
FREH_daily_projection <-
  FREH_monthly_projection %>% 
  mutate(days = days_in_month(month),
         date = as.Date(yearmon) + 15,
         projected_growth = round(projected_growth / days),
         projected_no_growth = round(projected_no_growth / days),
         projected_toronto = round(projected_toronto / days)) %>% 
  select(date, projected_growth, projected_no_growth, projected_toronto)

# Integrate into actual data
FREH_listings_trend <- 
  FREH_listings %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  left_join(FREH_daily_projection) %>% 
  mutate(projected_growth = if_else(date == start_proj, n, projected_growth),
         projected_no_growth = if_else(date == start_proj, 
                                       n, projected_no_growth),
         projected_toronto = if_else(date == start_proj, n, 
                                     projected_toronto)) %>%
  filter(date >= start_proj, 
         date <= start_proj + months(n_months - 1) + days(15)) %>%
  mutate(projected_growth = zoo::na.approx(projected_growth),
         projected_no_growth = zoo::na.approx(projected_no_growth),
         projected_toronto = zoo::na.approx(projected_toronto))

# Rbind with previous data
FREH_listings_trend <- 
  FREH_listings %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  filter(date < start_proj) %>% 
  bind_rows(FREH_listings_trend)

# Listing differences
FREH_listing_difs <- 
  FREH_listings_trend %>% 
  filter(date >= "2019-07-01") %>% 
  mutate(growth_df = projected_growth - n,
         no_growth_df = projected_no_growth - n,
         toronto_df = projected_toronto - n) %>% 
  summarize(avg_n = mean(n),
            avg_growth = mean(growth_df),
            avg_growth_pct = avg_growth / avg_n,
            avg_no_growth = mean(no_growth_df),
            avg_no_growth_pct = avg_no_growth / avg_n,
            avg_toronto = mean(toronto_df),
            avg_toronto_pct = avg_toronto / avg_n)

FREH_growth_dif <- 
  FREH_listing_difs %>% 
  pull(avg_growth) %>% 
  round(-1) %>% 
  prettyNum(",")

FREH_growth_dif_pct <- 
  FREH_listing_difs %>% 
  pull(avg_growth_pct) %>% 
  scales::percent(0.1)

FREH_no_growth_dif <- 
  FREH_listing_difs %>% 
  pull(avg_no_growth) %>% 
  round(-1) %>% 
  prettyNum(",")

FREH_no_growth_dif_pct <- 
  FREH_listing_difs %>% 
  pull(avg_no_growth_pct) %>% 
  scales::percent(0.1)

FREH_toronto_dif <- 
  FREH_listing_difs %>% 
  pull(avg_toronto) %>% 
  round(-1) %>% 
  prettyNum(",")

FREH_toronto_dif_pct <- 
  FREH_listing_difs %>% 
  pull(avg_toronto_pct) %>% 
  scales::percent(0.1)

rm(property_montreal, property_toronto, property, daily, daily_montreal, 
   daily_toronto, property_montreal_other, property_toronto_other,
   daily_montreal_other, daily_toronto_other, GH)

```

```{r montreal_toronto, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "cma_comparison.qsm"), nthreads = availableCores())

active_montreal <- 
  daily_montreal %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Montreal", type = "active")

active_toronto <- 
  daily_toronto %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Toronto", type = "active")

active_vancouver <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Vancouver", type = "active")

commercial_montreal <- 
  daily_montreal %>% 
  filter(housing, status != "B", (FREH_3 >= 0.5 | multi)) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Montreal", type = "commercial")

commercial_toronto <- 
  daily_toronto %>% 
  filter(housing, status != "B", (FREH_3 >= 0.5 | multi)) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Toronto", type = "commercial")

commercial_vancouver <- 
  daily %>% 
  filter(housing, status != "B", (FREH_3 >= 0.5 | multi)) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Vancouver", type = "commercial")

multi_montreal <- 
  daily_montreal %>% 
  filter(housing, status != "B", multi) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Montreal", type = "multi")

multi_toronto <- 
  daily_toronto %>% 
  filter(housing, status != "B", multi) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Toronto", type = "multi")

multi_vancouver <- 
  daily %>% 
  filter(housing, status != "B", multi) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Vancouver", type = "multi")

FREH_montreal <- 
  daily_montreal %>% 
  filter(housing) %>% 
  group_by(date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  mutate(n = slide_dbl(n, mean, .before = 20)) %>% 
  mutate(city = "Montreal", type = "FREH")

FREH_toronto <- 
  daily_toronto %>% 
  filter(housing) %>% 
  group_by(date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  mutate(n = slide_dbl(n, mean, .before = 20)) %>% 
  mutate(city = "Toronto", type = "FREH")

FREH_vancouver <- 
  daily %>% 
  filter(housing) %>% 
  group_by(date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  mutate(n = slide_dbl(n, mean, .before = 20)) %>% 
  mutate(city = "Vancouver", type = "FREH")

rm(property_montreal, property_toronto, property, daily, daily_montreal, 
   daily_toronto, property_montreal_other, property_toronto_other,
   daily_montreal_other, daily_toronto_other, GH)

```

**The City of Vancouver's STR licensing system has significantly and durably reduced the size of Vancouver's STR market and the domination of the market by dedicated commercial operators. Vancouver now fares substantially better on these metrics than either its peer cities Montreal and Toronto or the rest of the Metro Vancouver region. The 2018 implementation of the City's regulations created a one-time negative shock in the number of listings displayed on STR platforms in Vancouver, which dropped by `r displayed_drop`, or `r displayed_drop_pct` of the total displayed listings. This decline was disproportionately concentrated among listings which were present on STR platforms but not actively being rented; active listings dropped by `r active_drop`, or `r active_drop_pct`. Over the longer-term, we estimate that the regulations have reduced active STR listings by `r growth_dif`, or `r growth_dif_pct` of the total number of listings in the second half of 2019. We estimate that the City's regulations have returned `r FREH_growth_dif` housing units to the long-term market, compared to the counter-factual scenario where the regulations were not in place. This is `r FREH_growth_dif_pct` of the average number of dedicated entire-home STRs taking housing off the Vancouver market in the second half of 2019. Before the onset of the Covid-19 pandemic there were still upward of 2,500 housing units operating as dedicated STRs in Vancouver.**

<br>

## The City of Vancouver's STR regulations

In April 2018, the City of Vancouver enacted regulations on the operations of short-term rentals in the City, defined as rentals offered for fewer than thirty consecutive days (City of Vancouver, 2020a). Under these regulations, each STR operator is required to obtain a license for their rental unit; these licenses are only issued for STRs operated out of a host’s principal residence, and are valid for a single calendar year. Licensed listings can either be the entire principal residence or individual rooms within the residence. Although the regulations apply to STRs listed on any platform, Airbnb is the only STR platform that agreed to require hosts in Vancouver to fill out a license field in their online listing, to engage in data sharing, and to undertake operator education (City of Vancouver, 2020b). In August 2018, shortly before the City's announced start date for enforcement of the registration system, Airbnb removed approximately 2,400 listings which had not received licenses.

In what follows we assemble evidence about the of the City's regulations on the STR market. Given the significant restraints which the regulations impose on the market, their impacts should be highly visible if the regulations have been effective. If, by contrast, few impacts can be discerned, that implies that the regulations have not been effective. We carry out this task by analyzing the trajectory of STR activity in the City of Vancouver over time, and by comparing the City with a set of peer jurisdictions. This analysis collectively demonstrates that the City’s STR regulations have been effective at reducing STR activity and growth in Vancouver, and have accomplished that reduction in part by driving incoming visits to other municipalities within Metro Vancouver.

## The trajectory of post-regulation STR activity in Vancouver

``` {r make_fig_3_1}

figure_3_1_fun <- function(regular = "", condensed = "") {
  
  displayed_listings_all %>% 
    ggplot(aes(date, n, colour = blocked, linetype = min_30)) +
    annotate("segment", x = key_date_covid, xend = key_date_covid,
             y = -Inf, yend = Inf, alpha = 0.3) +
    annotate("segment", x = key_date_regulations, xend = key_date_regulations,
             y = -Inf, yend = Inf, alpha = 0.3) +
    geom_line(lwd = 1.5) +
    scale_y_continuous(name = NULL, label = scales::comma) +
    scale_linetype_discrete(name = NULL, labels = c("STR", "LTR")) +
    scale_x_date(name = NULL, limits = c(as.Date("2016-01-01"), NA)) +
    scale_colour_manual(name = NULL, values = col_palette[c(5, 1:3)]) +
    theme_minimal() +
    theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
          text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_1.pdf"), 
         plot = figure_3_1_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_1.pdf"))
}

```

The impact of the City's regulations can be directly measured in two ways: changes in the total number of listings on STR platforms in Vancouver, and changes in commercial listings which are highly likely to be non-compliant. Because all Vancouver STR listings are required to be licensed whether or not they are active, in Figure \@ref(fig:fig-3-1) we show the total number of listings displayed each day on Airbnb and Vrbo alongside our standard metric of active daily listings. In both cases we distinguish between short-term rental ("STR") listings (which have minimum reservations of 29 days or fewer, and are subject to the City's STR regulations) and long-term rental ("LTR") listings (which have minimum reservations of 30 days or more, and are not subject to the City's STR regulations). Displayed listings comprise active listings (i.e. listings which are either reserved or available for reservation) and inactive (blocked) listings which are visible on Airbnb or VRBO.

Two patterns are clear from Figure \@ref(fig:fig-3-1). First, the number of LTR listings on Airbnb and Vrbo (the dashed lines in Figure \@ref(fig:fig-3-1)) increased significantly in the run-up to the implementation of the City's STR regulations, presumably reflecting hosts converting possibly non-compliant STRs into LTR listings which are not subject to the regulations. Since mid-2019, there have consistently been just under 2,000 LTR listings displayed on Airbnb and Vrbo. In all the analysis which follows, these LTR listings are excluded, since they do not meet the City's definition of short-term rentals. Second, among STR listings (the solid lines in Figure \@ref(fig:fig-3-1)), both indicators show a sharp drop following Airbnb's mass removal of non-licensed listings in August 2018, but the decline is proportionally twice as large for displayed listings, which decreased `r displayed_drop` (`r displayed_drop_pct`) from August 20 to September 7, as it is for active listings, which decreased `r active_drop` (`r active_drop_pct`) over the same date range. Furthermore, displayed listings have never come close to regaining their pre-regulation numbers in Vancouver, while active listings had mostly recovered by the summer of 2019, a year after Airbnb's mass removal. Put differently, a disproportionate share of the large decline in STRs which followed Airbnb's mass removal was listings which were not actually in use on the platform anymore.

``` {r fig-3-1, include = TRUE, fig.cap = '(ref:fig-3-1)', fig.align = "center"}

figure_3_1_fun()

```

(ref:fig-3-1) _Displayed and active listings in the City of Vancouver (7-day average)_

``` {r make_fig_3_2}

figure_3_2_fun <- function(regular = "", condensed = "") {
  
  active_listings_trend %>%
    filter(date >= "2016-01-01") %>% 
    pivot_longer(-date) %>% 
    filter(!is.na(value)) %>%
    ggplot() +
    geom_ribbon(aes(x = date, ymin = n, ymax = projected_no_growth, group = 1),
                data = filter(active_listings_trend, !is.na(projected_growth)), 
                fill = col_palette[6], alpha = 0.3) +
    geom_ribbon(aes(x = date, ymin = projected_no_growth, 
                    ymax = projected_growth, group = 1),
                data = filter(active_listings_trend, !is.na(projected_growth)), 
                fill = col_palette[3], alpha = 0.3) +
    geom_ribbon(aes(x = date, ymin = projected_growth, 
                    ymax = projected_toronto, group = 1),
                data = filter(active_listings_trend, !is.na(projected_toronto)), 
                fill = col_palette[2], alpha = 0.3) +
    geom_line(aes(date, value, color = name), lwd = 1.5) +
    scale_x_date(name = NULL) +
    scale_y_continuous(name = NULL, labels = scales::comma) +
    scale_color_manual(name = NULL, 
                       labels = c("Actual active listings", 
                                  "Previous growth",
                                  "No growth",
                                  "Toronto's growth"), 
                       values = c("black", col_palette[c(1, 4, 5)])) +
    theme_minimal() +
    theme(legend.position = "bottom",
          panel.grid.minor.x = element_blank(),
          text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold"),
          legend.text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_2.pdf"), 
         plot = figure_3_2_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_2.pdf"))
}

```

Trend analysis allows for a more precise estimate of the impact of regulation on active listings. Figure \@ref(fig:fig-3-2) compares the actual number of active listings with two scenarios for the listings which would have been expected based on pre-August-2018 trends. The red line is a scenario where the growth rate of active listings from the previous two years continued into 2019. This is the most plausible "business as usual" scenario for what "natural" STR listing growth in Vancouver might have looked like in the absence of regulations. The lower, blue line is a scenario where aggregate growth in active listings stops, although seasonal variation continues. This latter scenario represents a lower bound on what the STR market might have looked like in the absence of regulations. The higher, green line is a scenario where Vancouver's STR market followed the trend of Toronto's market from mid-2018 onward. This is a quite similar to, although slightly higher than, the continued-growth scenario. (As we discuss below, the no-growth scenario is similar to Montreal's STR market trajectory.)

``` {r fig-3-2, include = TRUE, fig.cap = '(ref:fig-3-2)', fig.align = "center"}

figure_3_2_fun()

```

(ref:fig-3-2) _Actual and expected active listings after implementation of regulations_

What Figure \@ref(fig:fig-3-2) demonstrates is that, under any scenario, the City's regulations have had two different impacts on the number of active listings in Vancouver. The first is a one-time negative shock corresponding to Airbnb's mass listing removal, which has proven to be at least partially temporary. As of mid-2019, active listings were closer to their post-shock level than in the early days of the registration system in 2018. (The shaded areas of the graph show the difference between each of the scenarios and the actual number of active listings at any point in time, and the size of the shaded area is largest in late 2018 and early 2019.)

The second impact is a more durable shift downward in the STR listing growth curve. In the second half of 2019, the average difference between actual active listings and the two no-regulation counterfactuals was `r growth_dif` under the continued-growth scenario, `r no_growth_dif` under the no-growth scenario, and `r toronto_dif` under the Toronto-growth scenario. Based on the interjurisdictional comparisons performed below, we believe that the continued-growth scenario is the most plausible. Our conclusion is therefore that the City's STR regulations have, in the long-term, likely resulted in `r growth_dif` fewer active listings in Vancouver's STR market each day. This number represents `r growth_dif_pct` of the total number of active STRs in the city. The plausible lower and upper bounds, meanwhile, are `r no_growth_dif` - `r toronto_dif`, which is `r no_growth_dif_pct` - `r toronto_dif_pct` of the total number of active STRs in the city.

## Commercial STR operations

``` {r make_fig_3_3}

figure_3_3_fun <- function(regular = "", condensed = "") {
  
  commercial_listings %>% 
    group_by(commercial) %>% 
    mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
    ungroup() %>% 
    filter(date >= "2016-01-01") %>% 
    ggplot() +
    geom_line(aes(date, n, color = commercial), lwd = 1.5) +
    annotate("segment", x = key_date_covid, xend = key_date_covid,
             y = -Inf, yend = Inf, alpha = 0.3) +
    annotate("segment", x = key_date_regulations, xend = key_date_regulations,
             y = -Inf, yend = Inf, alpha = 0.3) +
    scale_x_date(name = NULL, limits = c(as.Date("2016-01-01"), NA)) +
    scale_y_continuous(name = NULL) +
    scale_colour_manual(name = "Listing type",
                        values = col_palette[c(5, 1)],
                        labels = c("Non-commercial", "Commercial")) +
    theme_minimal() +
    theme(legend.position = "bottom",
          panel.grid.minor.x = element_blank(),
          text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold"),
          legend.text = element_text(family = regular))
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_3.pdf"), 
         plot = figure_3_3_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_3.pdf"))
}

```

Since the 2018 regulations do not prohibit short-term rentals but merely limit them to hosts' principal residences, the fact that active listings in Vancouver have been significantly reduced by the regulations is not on its own decisive evidence of the effectiveness of the regulations. A harder to measure—but arguably more important—metric is the number of commercial STRs operating in Vancouver, given that they are necessarily non-compliant with the City's regulations. 

We measure commercial STRs in two ways. First, we measure the number of frequently-rented STR units, which are the simplest way to estimate STR-induced housing loss. If a STR is available for reservations the majority of the year and receives many bookings, it is reasonable to assume that it is not serving as an individual’s principal residence at the same time. Along these lines, we define frequently rented entire-home (FREH) listings as entire-home listings which were available on Airbnb or VRBO the majority of the year (at least 183 nights) and were booked a minimum of 90 nights. We then apply a statistical model (described in the appendix) to the FREH data in order to generate an estimate of FREH activity based on three months of listing activity. This allows us to detect listings which are operating in a full-time manner but have not yet been listed for an entire year, and allows us to account for relatively short-term changes in market conditions.

Secondly, we identify "multilistings"—STR listings operated by hosts which are simultaneously operating other listings. Some hosts operate multiple STR units, which can be an indication of a commercial operator rather than a casual home sharer. To take the simplest case, a host with two or more entire-home listings active on the same day cannot be operating both listings out of their principal residence, regardless of the frequency they are rented throughout the year. This means that these operators are not respecting the by-law, which prevents a person from operating a STR outside their principal residence. We consider entire-homes to be multilistings if they are operated by hosts who are simultaneously operating other entire-home listings. We define private-room multilistings as cases where a host has three or more private-room listings operating on the same day. Since 93.8% of entire-home listings have three or fewer bedrooms, there will be extremely few cases where a host operating three private-room STR listings in a dwelling unit has not converted the entire unit into a dedicated STR. Intuitively, multilistings that are still operating since the City’s STR regulations were enacted in April 2018 are almost certainly non-compliant.

Figure \@ref(fig:fig-3-3) decomposes the trajectory of active listings shown above (in Figure \@ref(fig:fig-3-1)) into commercial and non-commercial listings. The former are all listings which are either frequently rented entire-home (FREH) listings or multilistings. The graph shows that non-commercial listings experienced a noticeable drop when Airbnb carried out its August 2018 mass listing removal, but that the number of these listings was already in decline. The quantity of commercial listings, meanwhile, experienced a much sharper drop in August 2018 (`r commercial_pct_removed` of all commercial listings were removed by Airbnb) and continued to decline for the rest of 2018. Commercial operations recovered throughout 2019, however, and reached a new all-time high (`r peak_2019_commercial`) by the end of 2019.

``` {r fig-3-3, include = TRUE, fig.cap = '(ref:fig-3-3)', fig.align = "center"}

figure_3_3_fun()

```

(ref:fig-3-3) _Non-commercial and commercial active daily listings in Vancouver (7-day average)_

``` {r make_fig_3_4}

figure_3_4_fun <- function(regular = "", condensed = "") {
  
  FREH_listings_trend %>%
    filter(date >= "2016-01-01") %>% 
    pivot_longer(-date) %>% 
    filter(!is.na(value)) %>%
    ggplot() +
    geom_ribbon(aes(x = date, ymin = n, ymax = projected_no_growth, group = 1),
                data = filter(FREH_listings_trend, !is.na(projected_growth)), 
                fill = col_palette[6], alpha = 0.3) +
    geom_ribbon(aes(x = date, ymin = pmax(projected_no_growth, n),
                    ymax = projected_growth, group = 1),
                data = filter(FREH_listings_trend, !is.na(projected_growth)), 
                fill = col_palette[3], alpha = 0.3) +
    geom_ribbon(aes(x = date, ymin = projected_growth, 
                    ymax = projected_toronto, group = 1),
                data = filter(FREH_listings_trend, !is.na(projected_toronto)), 
                fill = col_palette[2], alpha = 0.3) +
    geom_line(aes(date, value, color = name), lwd = 1.5) +
    scale_x_date(name = NULL) +
    scale_y_continuous(name = NULL, labels = scales::comma) +
    scale_color_manual(name = NULL, 
                       labels = c("Actual FREH listings", 
                                  "Previous growth",
                                  "No growth",
                                  "Toronto's growth"), 
                       values = c("black", col_palette[c(1, 4, 5)])) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular,
                                      size = 10),
          legend.text = element_text( size = 10, , family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_4.pdf"), 
         plot = figure_3_4_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_4.pdf"))
}

```

Narrowing in on frequently rented entire-home (FREH) listings, Figure \@ref(fig:fig-3-4) offers a closer look at how the actual number of FREH listings compares with three scenarios where the mid-2018 regulations are not enacted: a growth-as-usual scenario where the FREH growth trend from the previous two years continues, a no-growth scenario where FREH growth had stopped by the time that the City's regulations were enacted, and a Toronto trend where FREH growth post-regulation followed the same growth rate as Toronto. Unlike the trend analysis of all active listings, above, where under all scenarios the regulations are likely to have substantially reduced the number of daily active listings, the effect of the City's regulations on commercial listings is highly sensitive to the scenario chosen. In the second half of 2019, the average difference between actual commercial listings and the two no-regulation counterfactuals was `r FREH_growth_dif` under the continued-growth scenario, `r FREH_no_growth_dif` under the no-growth scenario, and `r FREH_toronto_dif` under the Toronto-growth scenario. This is a six-fold difference. As with active listings above, we consider it most likely that FREH listing growth would have continued on its pre-regulation trend, and thus that the City's regulations have returned `r FREH_growth_dif` housing units to the long-term market—a reduction of `r FREH_growth_dif_pct`. But the actual number could plausibly be anywhere within the range `r FREH_no_growth_dif` - `r FREH_toronto_dif`, or `r FREH_no_growth_dif_pct` - `r FREH_toronto_dif_pct` of the average number of FREH listings which were active on STR platforms in the second half of 2019.

``` {r fig-3-4, include = TRUE, fig.cap = '(ref:fig-3-4)', fig.align = "center"}

figure_3_4_fun()

```

(ref:fig-3-4) _Actual and expected FREH listings after implementation of regulations_

``` {r make_fig_3_4a}

figure_3_4a_fun <- function(regular = "", condensed = "") {
  
  multi_listings_trend %>%
    filter(date >= "2016-01-01") %>% 
    pivot_longer(-date) %>% 
    filter(!is.na(value)) %>%
    ggplot() +
    geom_ribbon(aes(x = date, ymin = n, ymax = projected_no_growth, group = 1),
                data = filter(multi_listings_trend, !is.na(projected_growth)), 
                fill = col_palette[6], alpha = 0.3) +
    geom_ribbon(aes(x = date, ymin = projected_toronto,
                    ymax = projected_growth, group = 1),
                data = filter(multi_listings_trend, !is.na(projected_growth)), 
                fill = col_palette[3], alpha = 0.3) +
    geom_ribbon(aes(x = date, ymin = pmax(projected_no_growth, n), 
                    ymax = projected_toronto, group = 1),
                data = filter(multi_listings_trend, !is.na(projected_toronto)), 
                fill = col_palette[2], alpha = 0.3) +
    geom_line(aes(date, value, color = name), lwd = 1.5) +
    scale_x_date(name = NULL) +
    scale_y_continuous(name = NULL, labels = scales::comma) +
    scale_color_manual(name = NULL, 
                       labels = c("Actual multilistings", 
                                  "Previous growth",
                                  "No growth",
                                  "Toronto's growth"), 
                       values = c("black", col_palette[c(1, 4, 5)])) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular,
                                      size = 10),
          legend.text = element_text( size = 10, , family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_4a.pdf"), 
         plot = figure_3_4a_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_4a.pdf"))
}

```

Applying the same modelling to multilistings, we estimate that the City's regulations have reduced the number of these commercial STR operations by `r multi_growth_dif`, which corresponds to the continued-growth scenario, and is `r multi_growth_dif_pct` of the total amount of multilistings still active in Vancouver in late 2019. Two lower estimates, corresponding to the no-growth and Toronto-growth scenarios respectively, are `r multi_no_growth_dif` and `r multi_toronto_dif`. To be clear, however, in a scenario where the City's regulations were perfectly enforced, the value for the "actual FREH listings" and "actual multilistings" lines in Figure \@ref(fig:fig-3-4) and Figure \@ref(fig:fig-3-4a) would be zero, given that all non-principal-residence STRs are forbidden under the rules. Even allowing for some error in the measurement of commercial operators, at the end of 2019 there were almost certainly 2,500 or more listings operating in violation of the City's principal residence rules.

``` {r fig-3-4a, include = TRUE, fig.cap = '(ref:fig-3-4a)', fig.align = "center"}

figure_3_4a_fun()

```

(ref:fig-3-4a) _Actual and expected multilistings after implementation of regulations_


## The City of Vancouver in comparison with Montreal and Toronto

The preceding analysis varies significantly with the underlying assumptions being made about the growth of Vancouver's STR market prior to the introduction of the City's regulations. If we assume that growth would have continued along its previous trajectory, then the regulations have had a major impact on the number of active listings, and in particular on the number of commercial operations. If growth were already levelling off prior to the introduction of the regulations, by contrast, then it is likely that the regulations have somewhat reduced the number of active listings, but have been less effective at targeting the commercial operations which are not permitted under the rules.

There is no way to determine with certainty which of these scenarios would have occurred, but a promising strategy is to compare Vancouver with a set of similar jurisdictions which did not regulate their STR markets in mid-2018. Above we included Toronto's STR activity as an additional point of comparison for Vancouver, and in what follows we do this more systematically and at multiple spatial scales. We begin with the other two largest STR markets in the country: Toronto and Montreal. The City of Toronto has recently implemented mandatory host registration and a principal-residence requirement which are very similar to Vancouver's rules, but these were not active during the study period. The City of Montreal has rules which vary across the city, but in the key central-city boroughs commercial short-term rentals are largely forbidden. However, with no registration system in place during the study period, it has been widely understood that Montreal's enforcement mechanisms have not been sufficiently strong to significantly affect the operation of commercial STRs. Toronto and Montreal thus represent zero- or low-regulation cases with which to compare Vancouver.

```{r montreal_toronto_comparisons, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

van_mtl_active_dif_2017 <- 
  bind_rows(active_montreal, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Montreal"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_mtl_active_dif_2019 <- 
  bind_rows(active_montreal, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Montreal"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_to_active_dif_2017 <- 
  bind_rows(active_toronto, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Toronto"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_to_active_dif_2019 <- 
  bind_rows(active_toronto, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Toronto"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_to_active_counterfact <-
  bind_rows(active_toronto, active_vancouver) %>% 
  filter(year(date) == "2017") %>% 
  group_by(date) %>% 
  summarize(dif = n[city == "Toronto"] / n[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif)) %>% 
  pull(dif) %>% 
  {(active_toronto %>% 
      filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
      summarize(n = mean(n)) %>% 
      # filter(date == "2019-12-31") %>% 
      pull(n)) / .} %>% 
  scales::comma(10)
  
van_to_active_counterfact_dif <- 
  listing_difs$avg_n %>% 
  scales::comma(10)

van_to_FREH_dif_2017 <- 
  bind_rows(FREH_toronto, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Toronto"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_mtl_FREH_dif_2017 <- 
  bind_rows(FREH_montreal, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Montreal"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_to_FREH_dif_2019 <- 
  bind_rows(FREH_toronto, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Toronto"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_mtl_FREH_dif_2019 <- 
  bind_rows(FREH_montreal, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Montreal"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_to_multi_dif_2017 <- 
  bind_rows(multi_toronto, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Toronto"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_mtl_multi_dif_2017 <- 
  bind_rows(multi_montreal, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Montreal"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_to_multi_dif_2019 <- 
  bind_rows(multi_toronto, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Toronto"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_mtl_multi_dif_2019 <- 
  bind_rows(multi_montreal, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Montreal"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

```

``` {r make_fig_3_5}

figure_3_5_fun <- function(regular = "", condensed = "") {
  
  bind_rows(active_montreal, active_toronto, active_vancouver,
            FREH_montreal, FREH_toronto, FREH_vancouver,
            multi_montreal, multi_toronto, multi_vancouver) %>% 
    filter(date >= "2016-07-01", date <= "2019-12-31") %>% 
    group_by(city, type) %>% 
    mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
    ungroup() %>% 
    mutate(type = case_when(
      type == "active" ~ "Active listings", 
      type == "commercial" ~ "Commercial listings",
      type == "FREH" ~ "FREH listings",
      type == "multi" ~ "Multilistings")) %>% 
    ggplot(aes(date, index, colour = city, size = city)) +
    geom_line() +
    scale_y_continuous(name = NULL, label = scales::comma) +
    scale_x_date(name = NULL, limits = c(as.Date("2016-07-01"), NA)) +
    scale_colour_manual(name = NULL, 
                        values = col_palette[c(3, 6, 5)],
                        guide = guide_legend(override.aes = list(
                          size = c(0.5, 0.5, 1)))) +
    scale_size_manual(values = c("Vancouver" = 1, "Montreal" = 0.5,
                                 "Toronto" = 0.5), guide = "none") + 
    facet_wrap(vars(type), nrow = 1) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular),
          strip.text = element_text(face = "bold", family = regular, size = 10))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_5.pdf"), 
         plot = figure_3_5_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_5.pdf"))
}

```

Figure \@ref(fig:fig-3-5) compares the active listing (left), FREH listing (middle), and multilisting (right) trajectories in Montreal, Toronto and Vancouver. (Commercial listings are disaggregated into FREH listings and multilistings in order to clarify the key patterns.) The figure lends significant weight to the conclusion that Vancouver's STR regulations have significantly reduced the commercial portion of the STR market. The left panel demonstrates that the growth trajectory of active listings in Vancouver was on a very similar trajectory to Montreal and Toronto prior to 2018. In 2018 the three cities diverged, with listings in Vancouver plummeting in response to the new registration system, listings in Toronto continuing to grow quickly, and listings in Montreal beginning a long period of stagnation and decline. By the end of 2019 Vancouver's active listings had caught up to Montreal's in relative terms (in both cases with total numbers similar to the beginning of 2017), but were far behind Toronto's, which grew by more than 50% from 2017 through 2019.

Montreal was the first Canadian city to have a large STR market, driven by a combination of strong tourism and cheap housing (which incentivized conversions to STRs), and it has followed a trajectory comparable to other large tourist destinations—early growth then stagnation. Toronto and Vancouver began their periods of growth somewhat later, probably due in part to much higher housing prices reducing the financial incentives to operate STRs. Toronto thus represents the most likely counterfactual for how Vancouver's STR market would have evolved in the absence of regulations. Over the second half of 2019, Toronto had on average `r van_to_active_dif_2019` more active listings than Vancouver, relative to each city's market size on January 1, 2017. In 2017, by contrast, the difference was only `r van_to_active_dif_2017`. If the 2017 relationship between the two cities had remained consistent through 2019, Vancouver would have had `r van_to_active_counterfact` active listings at the end of the year—compared to the `r van_to_active_counterfact_dif` listings it actually did. This establishes a plausible upper-bound estimate for the impact of the City of Vancouver's regulations on the number of active STR listings, and lends support to our `r growth_dif_pct` estimate for the impact of Vancouver's regulations on active STR listings.

``` {r fig-3-5, include = TRUE, fig.cap = '(ref:fig-3-5)', fig.align = "center"}

figure_3_5_fun()

```

(ref:fig-3-5) _Active listings (L), FREH listings (C), and multilistings (R) in Montreal, Toronto and Vancouver (2017-01-01 = 100)_

The divergence between Vancouver and Montreal and Toronto is even more significant with respect to commercial listings, which were prohibited by Vancouver's regulations but were either de jure (Toronto) or de facto (Montreal) permitted in the other cases. The center and right panels of Figure \@ref(fig:fig-3-5) show, respectively, the trajectory of FREH listings and multilistings in the three cities. In both cases the three cities were on highly similar growth trajectories through 2017. Montreal's FREH listings were growing at a `r van_mtl_FREH_dif_2017` higher rate than Vancouver, while Toronto's FREH growth rate was identical to Vancouver's. Montreal's multilistings were growing at a `r van_mtl_multi_dif_2017` higher rate than Vancouver, while Toronto's were growing `r van_to_FREH_dif_2017` faster. In the second half of 2019, by which point the temporary impacts of Airbnb's mass listing removal in Vancouver would have subsided, the commercial side of Vancouver's market looked dramatically different from either Montreal or Toronto. Montreal's FREH listings had grown `r van_mtl_FREH_dif_2019` faster than Vancouver's, while Toronto's had grown an incredible `r van_to_FREH_dif_2019` faster. The numbers are similar for multilistings: Montreal outpaced Vancouver by `r van_mtl_multi_dif_2019`, and Toronto outpaced Vancouver by `r van_to_multi_dif_2019`.

These differences are summarized in Table \@ref(tab:tab-MTV). They strongly support the conclusion that the City of Vancouver's regulations have durably reduced the commercial part of Vancouver's STR market. Our "growth-as-usual" counterfactual had suggested that the regulations have reduced FREH listings by `r FREH_growth_dif_pct` and multilistings by `r multi_growth_dif_pct`. Comparison with Montreal and Toronto adds additional evidence suggesting that this estimate is plausible.

``` {r tab-MTV, include = TRUE}

library(kableExtra)

tibble(
  City = c("Montreal", "", "Toronto", ""),
  "Time period" = c("2017", "2019 (2H)", "2017", "2019 (2H)"),
  "Active listings" = c(van_mtl_active_dif_2017, van_mtl_active_dif_2019,
                        van_to_active_dif_2017, van_to_active_dif_2019),
  "FREH listings" = c(van_mtl_FREH_dif_2017, van_mtl_FREH_dif_2019,
                      van_to_multi_dif_2017, van_to_FREH_dif_2019),
  "Multilistings" = c(van_mtl_multi_dif_2017, van_mtl_multi_dif_2019,
                      van_to_FREH_dif_2017, van_to_multi_dif_2019)) %>% 
  kbl(caption = "Montreal and Toronto listing trajectories in comparison with Vancouver (values are the difference in growth rates relative to Vancouver’s growth rates in the same time period)", 
      align = "llrrr") %>% 
  kable_styling()

```

## The City of Vancouver in comparison with the rest of the Vancouver region

```{r bc_water, cache = TRUE, cache.lazy = FALSE}

ocean <- 
  read_sf(here("data", "shapefiles", "lhy_000h16a_e.shp")) %>% 
  st_transform(32610)

ocean <- 
  ocean %>% 
  st_filter(rbind(select(CMA, -everything()), select(city, -everything())))

river <- 
  read_sf(here("data", "shapefiles", "lhy_000c16a_e.shp")) %>% 
  st_transform(32610)

river <- 
  river %>% 
  st_filter(rbind(select(CMA, -everything()), select(city, -everything())))

water <- rbind(select(river, -everything()), select(ocean, -everything()))

rm(ocean, river)

```

```{r cma_comparisons, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_bc_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "str_bc_processed.qsm"), nthreads = availableCores())

active_bc <- 
  daily_bc %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Rest of CMA", type = "active")

commercial_bc <- 
  daily_bc %>% 
  filter(housing, status != "B", (FREH_3 >= 0.5 | multi)) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Rest of CMA", type = "commercial")

FREH_bc <- 
  daily_bc %>% 
  filter(housing, status != "B") %>% 
  group_by(date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  mutate(n = slide_dbl(n, mean, .before = 20)) %>% 
  mutate(city = "Rest of CMA", type = "FREH")

multi_bc <- 
  daily_bc %>% 
  filter(housing, status != "B", multi) %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  mutate(city = "Rest of CMA", type = "multi")

van_bc_active_dif_2017 <- 
  bind_rows(active_bc, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_active_dif_2018a <- 
  bind_rows(active_bc, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2018-01-01", date <= key_date_regulations) %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_active_dif_2018b <- 
  bind_rows(active_bc, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date > key_date_regulations, date <= "2018-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_active_dif_2019 <- 
  bind_rows(active_bc, active_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_FREH_dif_2017 <- 
  bind_rows(FREH_bc, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_FREH_dif_2018a <- 
  bind_rows(FREH_bc, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2018-01-01", date <= key_date_regulations) %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_FREH_dif_2018b <- 
  bind_rows(FREH_bc, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date > key_date_regulations, date <= "2018-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_FREH_dif_2019 <- 
  bind_rows(FREH_bc, FREH_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_multi_dif_2017 <- 
  bind_rows(multi_bc, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2017-01-01", date <= "2017-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_multi_dif_2018a <- 
  bind_rows(multi_bc, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2018-01-01", date <= key_date_regulations) %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_multi_dif_2018b <- 
  bind_rows(multi_bc, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date > key_date_regulations, date <= "2018-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

van_bc_multi_dif_2019 <- 
  bind_rows(multi_bc, multi_vancouver) %>% 
  group_by(city) %>% 
  mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
  ungroup() %>% 
  filter(date >= "2019-07-01", date <= "2019-12-31") %>% 
  group_by(date) %>% 
  summarize(dif = index[city == "Rest of CMA"] / index[city == "Vancouver"]) %>% 
  summarize(dif = mean(dif) - 1) %>% 
  pull(dif) %>% 
  scales::percent(0.1)

median_2019_rev_van <- 
  daily %>% 
  filter(housing, status == "R", date >= "2019-01-01", date <= "2019-12-31") %>% 
  group_by(price) %>% 
  summarize(revenue = sum(price)) %>% 
  pull(revenue) %>% 
  median() %>% 
  scales::dollar(100)

median_2019_rev_cma <- 
  daily_bc %>% 
  filter(housing, status == "R", date >= "2019-01-01", date <= "2019-12-31") %>% 
  group_by(price) %>% 
  summarize(revenue = sum(price)) %>% 
  pull(revenue) %>% 
  median() %>% 
  scales::dollar(100)

rm(property, daily, GH, property_bc, daily_bc)

```

``` {r make_fig_3_6}

figure_3_6_fun <- function(regular = "", condensed = "") {
  
  library(ggrepel)
  
  CMA_labels <-
    CMA %>% 
    mutate(name = str_remove(name, " \\(.*\\)")) %>% 
    group_by(name) %>% 
    summarize(dwellings = sum(Dwellings)) %>% 
    filter(dwellings > 10000) %>% 
    mutate(centroids = st_centroid(geometry),
           x = st_coordinates(centroids)[, 1],
           y = st_coordinates(centroids)[, 2]) %>% 
    st_drop_geometry() %>% 
    select(x, y, name)
  
  CMA %>% 
    ggplot() +
    geom_sf(data = province, fill = "grey70", colour = "transparent") +
    geom_sf(colour = "white", fill = col_palette[3]) +
    geom_sf(data = city, fill = col_palette[6], colour = "white") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    geom_text_repel(aes(x = x, y = y, label = name), data = CMA_labels, 
                    size = 3, family = regular) +
    geom_sf_text(aes(label = name), data = mutate(city, name = "Vancouver"),
                 fontface = "bold", family = regular) +
    gg_bbox(CMA) +
    theme_void() +
    theme(legend.position = "bottom")

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_6.pdf"), 
         plot = figure_3_6_fun("Futura", "Futura Condensed"), 
         width = 7, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_6.pdf"))
}

```

Another point of comparison for assessing the impact of the City's STR regulations is the rest of Metro Vancouver. While many visitors to Vancouver will be determined to stay within the City itself regardless of price or availability, others will be more flexible. So if the City's regulations have reduced the prevalence of commercial STRs, we should expect to see some redistribution of STR activity to neighbouring municipalities. We test this possibility by comparing the City of Vancouver with the remainder of the Vancouver Census Metropolitan Area (CMA), which is roughly coterminous with Metro Vancouver (Figure \@ref(fig:fig-3-6)).

``` {r fig-3-6, include = TRUE, fig.cap = '(ref:fig-3-6)', fig.align = "center"}

figure_3_6_fun()

```

(ref:fig-3-6) _The Vancouver Census Metropolitan Area (CMA)_

STR activity in the outlying municipalities of the Vancouver CMA is mostly concentrated in the cities of Richmond, Burnaby and Surrey, and there are substantial differences between the STR markets of the City of Vancouver and the these outlying municipalities. For example, the median listing in the City of Vancouver earned `r median_2019_rev_van` in 2019, while the median listing in the rest of the CMA earned `r median_2019_rev_cma`. However, examining the relative trajectories of listing growth since 2017, as was done above with Toronto and Montreal, provides additional context for the drop in active and commercial listings experienced in the City of Vancouver since mid-2018.

``` {r make_fig_3_7}

figure_3_7_fun <- function(regular = "", condensed = "") {
  
  bind_rows(active_bc, active_vancouver,
            FREH_bc, FREH_vancouver,
            multi_bc, multi_vancouver) %>% 
    filter(date >= "2016-07-01", date <= "2019-12-31") %>% 
    group_by(city, type) %>% 
    mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
    ungroup() %>% 
    mutate(type = case_when(
      type == "active" ~ "Active listings", 
      type == "commercial" ~ "Commercial listings",
      type == "FREH" ~ "FREH listings",
      type == "multi" ~ "Multilistings")) %>% 
    ggplot(aes(date, index, colour = city, size = city)) +
    geom_line() +
    scale_y_continuous(name = NULL, label = scales::comma) +
    scale_x_date(name = NULL, limits = c(as.Date("2016-07-01"), NA)) +
    scale_colour_manual(name = NULL, 
                        values = col_palette[c(3, 5)],
                        guide = guide_legend(override.aes = list(
                          size = c(0.5, 1)))) +
    scale_size_manual(values = c("Vancouver" = 1, "Rest of CMA" = 0.5), 
                      guide = "none") + 
    facet_wrap(vars(type), nrow = 1) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular),
          strip.text = element_text(face = "bold", family = regular, size = 10))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_7.pdf"), 
         plot = figure_3_7_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_7.pdf"))
}

```

Figure \@ref(fig:fig-3-7) shows the relative trajectories of active listings, FREH listings, and multilistings for the City of Vancouver and the rest of the Vancouver CMA since 2017. It demonstrates dramatic and widening divergences between the two geographies. While throughout 2017 active listings were already growing `r van_bc_active_dif_2017` faster in the rest of the CMA than in Vancouver, by the second half of 2019 the difference was `r van_bc_active_dif_2019`. FREH listings and multilistings reveal even larger divergences, from `r van_bc_FREH_dif_2017` to `r van_bc_FREH_dif_2019` for FREH listings and from `r van_bc_multi_dif_2017` to `r van_bc_multi_dif_2019` for multilistings.

``` {r fig-3-7, include = TRUE, fig.cap = '(ref:fig-3-7)', fig.align = "center"}

figure_3_7_fun()

```

(ref:fig-3-7) _Active listings (L), FREH listings (C), and multilistings (R) in the City of Vancouver and the rest of the Vancouver CMA (2017-01-01 = 100)_

How much of this divergence can be explained by Vancouver's STR regulations? At least some of the divergence was already underway by the time the City implemented its new rules, and in particular by the time that Airbnb undertook its mass removal of listings in August 2018. However, the divergence between Vancouver and the rest of the region widened significantly after August 2018—from `r van_bc_active_dif_2018a` to `r van_bc_active_dif_2018b` for active listings, from `r van_bc_FREH_dif_2018a` to `r van_bc_FREH_dif_2018b` for FREH listings, and from `r van_bc_multi_dif_2018a` to `r van_bc_multi_dif_2018b` for multilistings (Table \@ref(tab:tab-bc)). This suggests that the regulations were the most important (although not only) force shifting STR activity from the City of Vancouver to outlying municipalities.

``` {r tab-bc, include = TRUE}

library(kableExtra)

tibble(
  "Time period" = c("2017", "2018 before listing takedown", 
                  "2018 after listing takedown", "2019 (2H)"),
  "Active listings" = c(van_bc_active_dif_2017, van_bc_active_dif_2018a, 
                        van_bc_active_dif_2018b, van_bc_active_dif_2019),
  "FREH listings" = c(van_bc_FREH_dif_2017, van_bc_FREH_dif_2018a,
                      van_bc_FREH_dif_2018b, van_bc_FREH_dif_2019),
  "Multilistings" = c(van_bc_multi_dif_2017, van_bc_multi_dif_2018a,
                      van_bc_multi_dif_2018b, van_bc_multi_dif_2019)) %>% 
  kbl(caption = "Vancouver CMA listing trajectories in comparison with the City of Vancouver (values are the difference in growth rates relative to the City of Vancouver’s growth rates in the same time period)", 
      align = "lrrr") %>% 
  kable_styling()

```

```{r central_comparisons, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "str_bc_processed.qsm"), nthreads = availableCores())
qload(here("output", "cma_comparison.qsm"), nthreads = availableCores())

central_active_montreal <- 
  daily_montreal %>% 
  bind_rows(daily_montreal_other) %>% 
  filter(housing, status != "B") %>% 
  count(date, central) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Montreal", type = "Active listings")

central_active_toronto <- 
  daily_toronto %>% 
  bind_rows(daily_toronto_other) %>% 
  filter(housing, status != "B") %>% 
  count(date, central) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Toronto", type = "Active listings")

central_active_vancouver <- 
  daily %>% 
  mutate(central = TRUE) %>% 
  bind_rows(mutate(daily_bc, central = FALSE)) %>% 
  filter(housing, status != "B") %>% 
  count(date, central) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Vancouver", type = "Active listings")

central_FREH_montreal <- 
  daily_montreal %>% 
  bind_rows(daily_montreal_other) %>% 
  filter(housing, status != "B") %>% 
  group_by(date, central) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Montreal", type = "FREH listings")

central_FREH_toronto <- 
  daily_toronto %>% 
  bind_rows(daily_toronto_other) %>% 
  filter(housing, status != "B") %>% 
  group_by(date, central) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Toronto", type = "FREH listings")

central_FREH_vancouver <- 
  daily %>% 
  mutate(central = TRUE) %>% 
  bind_rows(mutate(daily_bc, central = FALSE)) %>% 
  filter(housing, status != "B") %>% 
  group_by(date, central) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Vancouver", type = "FREH listings")

central_multi_montreal <- 
  daily_montreal %>% 
  bind_rows(daily_montreal_other) %>% 
  filter(housing, status != "B", multi) %>% 
  count(date, central) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Montreal", type = "Multilistings")

central_multi_toronto <- 
  daily_toronto %>% 
  bind_rows(daily_toronto_other) %>% 
  filter(housing, status != "B", multi) %>% 
  count(date, central) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Toronto", type = "Multilistings")

central_multi_vancouver <- 
  daily %>% 
  mutate(central = TRUE) %>% 
  bind_rows(mutate(daily_bc, central = FALSE)) %>% 
  filter(housing, status != "B", multi) %>% 
  count(date, central) %>% 
  group_by(date) %>% 
  summarize(central_pct = n[central] / sum(n)) %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(city = "Vancouver", type = "Multilistings")

rm(property, daily, GH, property_montreal, property_montreal_other,
   property_toronto, property_toronto_other, daily_montreal, 
   daily_montreal_other, daily_toronto, daily_toronto_other,
   property_bc, daily_bc)

```

``` {r make_fig_3_8}

figure_3_8_fun <- function(regular = "", condensed = "") {
  
  bind_rows(central_active_montreal, central_active_toronto, 
            central_active_vancouver, central_FREH_montreal,
            central_FREH_toronto, central_FREH_vancouver,
            central_multi_montreal, central_multi_toronto,
            central_multi_vancouver) %>% 
    filter(date <= "2019-12-31") %>% 
    ggplot(aes(date, central_pct, colour = city, size = city)) +
    geom_line() +
    scale_y_continuous(name = NULL, label = scales::percent) +
    scale_x_date(name = NULL, limits = c(as.Date("2016-07-01"), NA)) +
    scale_colour_manual(name = NULL, 
                        values = col_palette[c(3, 6, 5)],
                        guide = guide_legend(override.aes = list(
                          size = c(0.5, 0.5, 1)))) +
    scale_size_manual(values = c("Vancouver" = 1, "Montreal" = 0.5,
                                 "Toronto" = 0.5), guide = "none") + 
    facet_wrap(vars(type), nrow = 1) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular),
          strip.text = element_text(face = "bold", family = regular, size = 10))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_8.pdf"), 
         plot = figure_3_8_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_8.pdf"))
}

```

Another way to examine the relationship between the City of Vancouver and the rest of the CMA is to compare the proportion of total regional active listings, FREH listings and multilistings located in the central city with the same proportion in the Montreal and Toronto regions. Figure \@ref(fig:fig-3-8) shows this comparison, and makes clear that Vancouver's STR market has long had an atypical relationship with that of its surrounding municipalities. In Montreal and Vancouver, the central city dominates the regional STR market in terms of total active listings, and on top of that has disproportionately high shares of FREH listings and multilistings. While in both cases outlying municipalities are slowly increasing their share of the regional market, as of the end of 2019 the central cities still had between 75% and 90% of the regional share of the various listing types. Vancouver had both a substantially lower share of its regional STR market in 2016 (where the graph begins) and a much sharper decrease in regional share across all listing categories.

``` {r fig-3-8, include = TRUE, fig.cap = '(ref:fig-3-8)', fig.align = "center"}

figure_3_8_fun()

```

(ref:fig-3-8) _The share of active listings, FREH listings and multilistings in the central city of the Montreal, Toronto and Vancouver CMAs_

The fact that more STR activity is located in outer municipalities of the Vancouver region than in Montreal or Toronto is not surprising, given that the City of Vancouver makes up a much smaller part of its CMA than the other two cities. Vancouver's declining share of regional STR activity began well before the City's regulations were put into place. At the same time, the City's share of regional STR activity dropped noticeably in 2018, and the drop has proven to be durable. These facts suggest that the City's 2018 regulations accelerated a shift of STR activity from Vancouver to the neighbouring municipalities that was already underway. It is also notable that Vancouver now has a much smaller share of the region's multilistings than it does of active listings as a whole, but that it has a _larger_ share of FREH listings than it does of active listings as a whole. This pattern indicates that Vancouver's registration system has discouraged hosts from operating multiple listings simultaneously—a prima facie violation of the principal residence requirement—but that the system has not proven as effective at deterring full-time operation of a single listing, which is equally prohibited under the rules but arguably harder to detect.

## The eastern edge of the City of Vancouver in comparison with the western edge of the City of Burnaby

```{r burnaby, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "str_bc_processed.qsm"), nthreads = availableCores())

# Prepare buffer
buffer_CoV_Burnaby <- 
  st_intersection(select(st_cast(city, "MULTILINESTRING"), -everything()), 
                  select(filter(st_cast(CMA, "MULTILINESTRING"), 
                                name == "Burnaby (CY)"), -everything())) %>% 
  st_cast("LINESTRING") %>%
  st_buffer(dist = 1000, joinStyle = "MITRE", mitreLimit = 0.1)

# Properties within the buffer
property_buffer <- 
  property %>% 
  mutate(group = "CoV") %>% 
  select(property_ID, group) %>% 
  rbind(select(mutate(property_bc, group = "Burnaby"), property_ID, group)) %>%
  st_filter(buffer_CoV_Burnaby)

# Active listings within the buffer
daily_buffer <- 
  rbind(select(daily, property_ID:status, price, listing_type, housing, multi, 
               FREH_3), 
        select(daily_bc, property_ID:status, price, listing_type, housing, 
               multi, FREH_3)) %>% 
  inner_join(st_drop_geometry(property_buffer))

active_listings_buffer <- 
  daily_buffer %>% 
  filter(housing, status != "B") %>% 
  count(date, group) %>% 
  group_by(group) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup()

burnaby <-
  CMA %>%
  filter(name == "Burnaby (CY)")

buffer_city <- 
  st_intersection(buffer_CoV_Burnaby, select(city, -everything()))

buffer_burnaby <- 
  st_intersection(buffer_CoV_Burnaby, select(burnaby, -everything()))

buffer <- 
  rbind(mutate(buffer_city, city = "Vancouver listings"), 
        mutate(buffer_burnaby, city = "Burnaby listings"))

properties <- 
  rbind(rename(select(property_bc, property_ID, last_active), 
               active = last_active),
        select(property, property_ID, active)) %>% 
  filter(!property_ID %in% property_buffer$property_ID, active >= "2020-01-01")

active_buffer <- 
  daily_buffer %>% 
  mutate(city = if_else(group == "CoV", "Vancouver border", 
                        "Burnaby border")) %>% 
  filter(housing, status != "B") %>% 
  count(city, date) %>% 
  group_by(city) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  ungroup() %>% 
  filter(date >= "2016-01-01", date <= "2019-12-31") %>% 
  mutate(type = "Active listings")

FREH_buffer <- 
  daily_buffer %>% 
  mutate(city = if_else(group == "CoV", "Vancouver border", 
                        "Burnaby border")) %>% 
  filter(housing, status != "B") %>% 
  group_by(city, date) %>% 
  summarize(n = sum(FREH_3, na.rm = TRUE)) %>% 
  mutate(n = slide_dbl(n, mean, .before = 20)) %>% 
  ungroup() %>% 
  mutate(type = "FREH listings")

multi_buffer <- 
  daily_buffer %>% 
  mutate(city = if_else(group == "CoV", "Vancouver border", 
                        "Burnaby border")) %>% 
  filter(housing, status != "B", multi) %>% 
  count(city, date) %>% 
  group_by(city) %>% 
  mutate(n = slide_dbl(n, mean, .before = 13)) %>% 
  ungroup() %>% 
  mutate(type = "Multilistings")

rm(property, daily, GH, property_bc, daily_bc)

```

```{r cma_streets, cache = TRUE, cache.lazy = FALSE}

library(osmdata)

cma_streets <- 
  getbb("Metro Vancouver") %>% 
  opq(timeout = 200) %>% 
  add_osm_feature(key = "highway") %>% 
  osmdata_sf()

cma_streets <-
  rbind(
    cma_streets$osm_polygons %>% st_set_agr("constant") %>% st_cast("LINESTRING"), 
    cma_streets$osm_lines) %>% 
  as_tibble() %>% 
  st_as_sf() %>% 
  st_transform(32610) %>%
  st_set_agr("constant")

cma_streets <- 
  cma_streets %>% 
  filter(highway %in% c("primary", "secondary")) %>% 
  select(osm_id, name, highway, geometry)

```

``` {r make_fig_3_9}

figure_3_9_fun <- function(regular = "", condensed = "") {
  
  ggplot() +
    geom_sf(data = city, fill = "grey70", color = "white", size = 0.5) +
    geom_sf(data = CMA, fill = "grey80", color = "white", size  = 0.5) +
    geom_sf(data = buffer, alpha = 0.8, colour = "transparent") +
    geom_sf(data = properties, colour = "grey60", size = 0.5) +
    geom_sf(data = cma_streets, color = "white") +
    geom_sf(aes(color = group), data = property_buffer, size = 0.5) +
    geom_sf(data = water, fill = "white", color = "transparent") +
    scale_color_manual(
      name = NULL, labels = c("Burnaby listings", "Vancouver listings"),
      values = c("Burnaby" = col_palette[c(1)], "CoV" = col_palette[c(5)])) +
    coord_sf(xlim = c(st_bbox(buffer)["xmin"] - 8500, 
                      st_bbox(buffer)["xmax"] + 8500),
             ylim = c(st_bbox(buffer)["ymin"] - 500, 
                      st_bbox(buffer)["ymax"] + 500)) +
    theme_void() +
    theme(legend.position = "bottom",
          legend.text = element_text(size = 10, family = regular))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_9.pdf"), 
         plot = figure_3_9_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_9.pdf"))
}

```

We conducted a final comparison at a smaller scale designed to directly assess the impact of the City's regulations on STR growth trajectories, by examining listings lying within one kilometre of the Vancouver-Burnaby border, in both Vancouver and Burnaby. Listings located in the study zone on either side of the Vancouver-Burnaby will be highly comparable from a visitor's perspective. The only significant difference between these listings is that some are located in the City of Vancouver, and are subject to its regulations, while some are located in the City of Burnaby, and are not. (We conducted an additional analysis of listings within walking distance of SkyTrain stations on both sides of the Vancouver border to reduce non-regulatory variations between listings even more, but the results were very similar to this analysis, so we have not presented them.) If listings in the study zone on the Vancouver side of the border display growth trajectories similar to their counterparts on the Burnaby side, this implies that the City's regulations are not meaningfully constraining STR operators in Vancouver. By contrast, if listings in the study zone on the Vancouver side of the border display growth trajectories dissimilar to their counterparts on the Burnaby side but similar to the rest of the City of Vancouver, this implies that the City's regulations have had a significant impact.

``` {r fig-3-9, include = TRUE, fig.cap = '(ref:fig-3-9)', fig.align = "center"}

figure_3_9_fun()

```

(ref:fig-3-9) _Study area for comparison: a 1-km strip on either side of the Vancouver-Burnaby border_

``` {r make_fig_3_10}

figure_3_10_fun <- function(regular = "", condensed = "") {
  
  bind_rows(active_buffer, FREH_buffer, multi_buffer,
            mutate(active_vancouver, type = "Active listings"), 
            mutate(FREH_vancouver, type = "FREH listings"),
            mutate(multi_vancouver, type = "Multilistings")) %>% 
    filter(date >= "2016-07-01", date <= "2019-12-31") %>% 
    group_by(city, type) %>% 
    mutate(index = 100 * n / n[date == "2017-01-01"]) %>% 
    ungroup() %>% 
    ggplot(aes(date, index, colour = city, size = city)) +
    geom_line() +
    scale_y_continuous(name = NULL, label = scales::comma) +
    scale_x_date(name = NULL, limits = c(as.Date("2016-07-01"), NA)) +
    scale_colour_manual(name = NULL, 
                        values = col_palette[c(3, 6, 5)],
                        guide = guide_legend(override.aes = list(
                          size = c(0.5, 0.5, 1)))) +
    scale_size_manual(values = c("Vancouver border" = 1, "Burnaby border" = 0.5,
                                 "Vancouver" = 0.5), 
                      guide = "none") + 
    facet_wrap(vars(type), nrow = 1) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular),
          strip.text = element_text(face = "bold", family = regular, size = 10))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_10.pdf"), 
         plot = figure_3_10_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_10.pdf"))
}

```

The results of the comparison, shown in Figure \@ref(fig:fig-3-10) are highly illuminating. Listings located in Vancouver but near the border with Burnaby have been on a growth trajectory which resembles nearby listings in Burnaby in some respects, and which resembles the rest of the City of Vancouver in others. First of all, growth trajectories across all listing types have been significantly lower in the Vancouver border listings than the Burnaby border listings since the implementation of the City's STR regulations in 2018. This provides clear and compelling evidence that the regulations have reduced STR activity. However, there is a substantial difference between the patterns with respect to FREH listings (dedicated STRs which have removed housing from the long-term market) and multilistings (listings operated by a host who is simultaneously operating other listings). Multilistings in the Vancouver border area have grown far less quickly since 2018 than their counterparts in Burnaby, and nearly identically to multilistings elsewhere in Vancouver. But FREH listings in the Vancouver border area have grown extremely rapidly—not as quickly their counterparts in Burnaby, but more than twice as quickly as the rest of Vancouver. Both of these categories of listings will be in violation of the City's principal residence requirement, but multilistings have evidently been much more significantly restrained by the regulations than FREH listings have been. This is the same pattern that the comparison of the City of Vancouver with the rest of the Vancouver CMA revealed.

``` {r fig-3-10, include = TRUE, fig.cap = '(ref:fig-3-10)', fig.align = "center"}

figure_3_10_fun()

```

(ref:fig-3-10) _Active listings (L), FREH listings (C), and multilistings (R) along the Vancouver-Burnaby border (2017-01-01 = 100)_

## Conclusions

This chapter has presented a variety of comparisons designed to isolate the impact of the City of Vancouver's 2018 STR regulations on Vancouver's STR market. Across the different comparisons, the following findings emerged:

- The initial implementation of the City's licensing system and Airbnb's subsequent mass removal of non-licensed listings created a one-time negative shock in the number of STR listings in Vancouver in mid-2018. But this shock was disproportionately concentrated among listings which were present on STR platforms but not actively being rented, and active listings grew more quickly in 2019 to partially counteract the effects of this shock.
- Trend analysis suggests that the City's regulations have reduced active STR listings in Vancouver by `r growth_dif`, or `r growth_dif_pct` of total active listings, within a plausible range of `r no_growth_dif` - `r toronto_dif`. We estimate that the regulations have returned `r FREH_growth_dif` housing units to the long-term market, within a plausible range of `r FREH_no_growth_dif` - `r FREH_toronto_dif`.
- Comparisons with other jurisdictions uniformly suggest that the real impact of the City's STR regulations is at the higher end of the trend analysis scenarios. Since 2018, Vancouver's STR market has developed more slowly and in a less commercialized direction than Montreal or Toronto, while a substantial amount of commercial STR activity has relocated to nearby municipalities in Metro Vancouver.
- Comparisons with nearby municipalities suggest that, among commercial STR operations, multilistings have been particularly constrained by the City's regulations, while dedicated FREH listings have grown less than they otherwise would have, but at something closer to the rate expected in the absence of regulations. This pattern is consistent with a scenario where the City's licensing system has been extremely successful at discouraging hosts from licensing multiple listings, but has been less successful at discouraging hosts from operating single listings in a full-time fashion, despite the fact that both these categories of use are non-compliant with the City's principal residence requirement.

\newpage
